# 转场与资源加载重构及地图存储优化设计

## 1. 概述
本设计文档旨在解决以下问题：
1.  游戏启动和进入标题画面时的卡顿问题。
2.  地图区域存储结构分散的问题。
3.  转场效果单一，缺乏针对性的视觉反馈。

## 2. 统一资源加载 (Preloader)

### 2.1 现状分析
目前游戏资源（纹理、音频等）可能分散在各个类的静态初始化块或构造函数中加载，导致主线程阻塞，产生卡顿。

### 2.2 解决方案
引入 `PreloaderScreen` 作为游戏的第一个屏幕，负责：
1.  初始化 `AssetManager`。
2.  排队加载所有核心资源（UI Skin, 通用纹理, 音效, BGM）。
3.  显示加载进度条或动画。
4.  加载完成后切换至 `MainMenuScreen`。

### 2.3 类设计
*   **AssetProxy**: 封装 `AssetManager`，提供统一的 `load()`, `get()`, `update()` 接口。
*   **PreloaderScreen**: 
    *   `show()`: 开始异步加载任务。
    *   `render()`: 调用 `AssetProxy.update()`，并绘制加载动画（小人奔跑）。
    *   完成时: `ScreenManager.getInstance().goScreen(new MainMenuScreen());`

## 3. 双预设转场系统

### 3.1 需求
*   **Type A (Loading转场)**: 小人跑步 + 文字提示。用于耗时操作（如进入游戏、切换区域）。
*   **Type B (快速转场)**: 简单的淡入淡出。用于快速切换（如打开菜单、层间切换）。

### 3.2 ScreenManager 增强
在 `ScreenManager` 中扩展转场接口：

```java
// Type A: Loading Transition
public void playLoadingTransition(Consumer<Runnable> task, String tipText, float minDuration);

// Type B: Fast Fade Transition
public void playFadeTransition(Runnable onMiddle);
```

### 3.3 LoadingRenderer 实现
创建一个 `RunningManLoadingRenderer` 实现 `ScreenManager.LoadingRenderer` 接口：
*   绘制黑色背景。
*   绘制跑动的小人动画（使用 Spine 或序列帧）。
*   绘制动态提示文字（"初始化游戏资源中...", "去往 [区域名] 中"）。

## 4. 地图区域单文件存储

### 4.1 现状
目前每个楼层保存为一个独立的 JSON 文件 (`floor_0.json`, `floor_1.json`...)。

### 4.2 新结构
每个区域（Area）保存为一个单一的 JSON 文件 (`area_id.json`)。

#### 数据结构
```java
public class AreaMapData {
    public String areaId;
    public Map<Integer, LayerData> floors = new HashMap<>();
    // 可扩展：区域级元数据
}
```

### 4.3 SaveManager 改造
*   `saveLayerData(..., int floor, LayerData data)` -> `saveAreaMap(..., String areaId, AreaMapData data)`。
*   逻辑调整：
    1.  读取现有的 `AreaMapData` (如果存在)。
    2.  更新指定 `floor` 的 `LayerData`。
    3.  将整个 `AreaMapData` 写回文件。
*   **注意**: 这种方式在保存单层时会读写整个文件，对于大型区域可能存在性能损耗，但在当前规模下可接受且符合单文件存储需求。

## 5. 执行计划
1.  **资源加载**: 创建 `AssetProxy` 和 `PreloaderScreen`，修改 `MagicDungeon2` 入口。
2.  **转场系统**: 实现 `RunningManLoadingRenderer`，更新 `ScreenManager`。
3.  **地图重构**: 定义 `AreaMapData`，重写 `SaveManager` 相关方法，更新 `GameScreen` 保存逻辑。
