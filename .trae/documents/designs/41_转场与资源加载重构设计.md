# 转场与资源加载重构设计 (v0.10.0)

## 1. 概述
当前游戏在场景切换（如从“羊皮卷”选择关卡进入地牢）时，存在以下问题：
1.  **实例重建**: 每次进入地牢都销毁并重建 `GameScreen`，导致状态丢失且开销大。
2.  **转场生硬**: 缺乏平滑的过渡动画，加载过程无反馈。
3.  **逻辑耦合**: `ProgressScreen` 直接依赖 `ScreenManager` 进行跳转，无法灵活复用。

本方案旨在重构这一流程，引入**带加载动画的异步转场机制**，并实现 `GameScreen` 的**场景重构（Rebuild）**而非销毁重建。

## 2. 核心组件设计

### 2.1 ScreenManager 转场增强
新增 `playLoadingTransition` 方法，支持“最小展示时间”和“异步等待”机制。

**API 设计**:
```java
/**
 * 执行带加载动画的转场
 * @param loader 异步加载任务，接受一个 finishCallback。当加载完成时必须调用此 callback。
 * @param minDuration 最小转场持续时间 (秒)，防止加载过快导致动画闪烁。
 */
public void playLoadingTransition(Consumer<Runnable> loader, float minDuration);
```

**加载屏 (LoadingOverlay)**:
*   **视觉**: 纯黑背景 + 底部进度条/文字 + 屏幕中央奔跑的主角小人 (Spine 动画)。
*   **逻辑**:
    1.  启动转场，立即显示 Overlay（淡入或直接覆盖）。
    2.  开始播放奔跑动画。
    3.  执行 `loader` 任务。
    4.  等待 `minDuration` 耗尽 **且** `loader` 调用了 `finishCallback`。
    5.  两个条件都满足后，Overlay 淡出，显示目标屏幕内容。

### 2.2 GameScreen 场景重构 (In-Place Rebuild)
不再 `new GameScreen()`，而是复用现有实例，通过 `rebuildScene` 方法切换内容。

**方法定义**:
```java
public void rebuildScene(String areaId, int level, Runnable onFinish);
```

**执行流程**:
1.  保存当前状态 (如需)。
2.  清理当前场景实体 (Monsters, Items)。
3.  **异步/同步** 加载新地图数据 (`dungeon.generate` 或 `MapIO.load`)。
4.  重置玩家位置。
5.  生成新实体。
6.  调用 `onFinish.run()` 通知转场结束。

### 2.3 ProgressScreen (羊皮卷) 交互优化
将 `ProgressScreen` 定位为 **模态选择器** 而非独立流程节点。

**交互流**:
1.  `GameScreen` 打开 `ProgressScreen`:
    ```java
    ProgressScreen selector = new ProgressScreen();
    selector.setOnSelect((node) -> {
        // 1. 关闭选择屏 (Pop)
        ScreenManager.getInstance().popLastScreen();
        
        // 2. 在当前 GameScreen (已显露) 播放转场并重构场景
        ScreenManager.getInstance().playLoadingTransition((finishCallback) -> {
            // 执行重构，完成后触发 finishCallback
            this.rebuildScene(node.id, node.minLv, finishCallback);
        }, 1.5f);
    });
    ScreenManager.getInstance().goScreen(selector);
    ```

## 3. 详细实现步骤

### Phase 1: ScreenManager 改造
1.  引入 `LoadingOverlay` 类 (内部类或独立类)，负责渲染跑酷动画。
2.  实现 `playLoadingTransition` 状态机：`IDLE` -> `IN` -> `WAITING` -> `OUT`。
3.  处理输入拦截：转场期间拦截所有用户输入。

### Phase 2: GameScreen 改造
1.  提取 `initWorld` / `generateDungeon` 逻辑到 `rebuildScene`。
2.  确保 `rebuildScene` 能够正确重置 HUD、相机、物理状态等。

### Phase 3: 整合与验证
1.  修改 `ProgressScreen`，增加 `onSelect` 回调接口。
2.  在 `GameScreen` 中通过羊皮卷道具/按键打开 `ProgressScreen` 并注入回调。
3.  验证：
    *   打开羊皮卷 -> 选择关卡 -> 羊皮卷关闭 -> 出现跑酷动画 (至少1.5s) -> 场景变更为新关卡 -> 动画结束。

## 4. 动画细节
*   **小人动画**: 复用 `LoadingScreen` 中的 Spine 逻辑，或者将其封装为通用组件 `SpineLoadingWidget`。
*   **位置**: 屏幕水平居中，Y轴偏下。
*   **进度反馈**: 可选显示 "正在前往 [区域名]..." 文字。
