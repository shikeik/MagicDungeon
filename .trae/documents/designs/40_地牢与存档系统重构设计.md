# 地牢与存档系统重构设计案

## 1. 概述

本设计案旨在解决当前项目数据结构混乱、存档系统单一、地图加载机制不灵活等问题。通过重构数据结构、引入目录式存档管理、优化游戏启动流程和编辑器功能，提升系统的可扩展性和稳定性。

## 2. 数据结构重构

### 2.1 核心数据类

我们将废弃旧的扁平化结构，采用层级化的数据模型。

*   **`SaveData` (存档元数据)**:
    *   `String saveName`: 存档名称（目录名）
    *   `long createTime`: 创建时间
    *   `long lastPlayedTime`: 最后游玩时间
    *   `String currentPlayerName`: 当前主要玩家名（用于显示）
    *   `String currentAreaId`: 当前所在区域ID
    *   `int currentFloor`: 当前所在层数

*   **`PlayerData` (玩家数据)**:
    *   `String name`: 玩家名称
    *   `Inventory inventory`: 背包数据
    *   `Stats stats`: 属性数据（生命、魔法等）
    *   `Equipment equipment`: 装备数据
    *   `Vector2 position`: 当前位置
    *   *存储位置*: `saves/game_saves/<save_name>/players/<player_name>.json`

*   **`AreaData` (区域数据)**:
    *   `String areaId`: 区域ID (如 "camp", "dungeon_1")
    *   `Map<Integer, LayerData> layers`: 层数据映射 (层号 -> 数据)
    *   *存储位置*: 逻辑概念，实际按层存储或分块存储。为简化，初期可将单层存为独立文件，或整个区域存为一个文件（如果区域不大）。
    *   **改进方案**: 鉴于地牢可能很大，建议采用 `areas/<area_id>/floor_<level>.json` 的结构。

*   **`LayerData` (层数据)**:
    *   `int width`: 宽度
    *   `int height`: 高度
    *   `String[] floorIds`: 地皮层数据 (压缩存储，使用ID字符串数组)
    *   `String[] blockIds`: 方块层数据 (压缩存储)
    *   `List<EntityData> entities`: 实体列表
    *   `List<ItemData> items`: 掉落物列表
    *   *存储*: 作为 `AreaData` 的一部分或独立文件。

### 2.2 存储格式优化

*   **方块/地皮存储**: 不再序列化整个 `Tile` 对象，而是仅存储 `String[]` ID 数组。
    *   `TileType` 需要有稳定的 String ID。
    *   数组大小 = `width * height`。
    *   索引 `i = y * width + x`。

## 3. 存档目录结构

新的存档系统将基于目录管理，支持多存档。

```
saves/
  game_saves/
    my_save_1/
      meta.json          (SaveData)
      players/
        player1.json     (PlayerData)
      areas/
        camp/
          floor_1.json   (LayerData - 营地通常只有一层)
        stone_tower/
          floor_1.json
          floor_5.json
          floor_10.json
        misty_wetlands/
          ...
```

## 4. 游戏流程重构

### 4.1 标题画面与新游戏

*   **新游戏**:
    1.  点击“新游戏”按钮。
    2.  弹出创建窗口：
        *   输入存档名称 (作为目录名)。
        *   输入玩家名称。
    3.  点击“完成”：
        *   跳转 **加载界面**。
        *   后台执行 `WorldCreationTask`。

*   **继续游戏**:
    1.  点击“继续游戏”按钮。
    2.  弹出存档选择窗口 (列出 `saves/game_saves/` 下的所有存档)。
    3.  选择存档后，跳转 **加载界面**。

### 4.2 加载界面

*   **UI**:
    *   背景：黑色或模糊的游戏背景。
    *   中心：Spine 动画 `large_sworder` 循环跑动。
    *   底部：进度条或提示文字。
*   **逻辑**:
    *   **新游戏模式**:
        1.  创建目录 `saves/game_saves/<save_name>/`。
        2.  创建 `meta.json`。
        3.  创建初始 `PlayerData`。
        4.  **关键步骤**: 遍历 `assets/maps/` 目录 (使用 `AssetUtils`)，将所有预设区域文件复制到 `saves/game_saves/<save_name>/areas/` 下。
            *   若 `assets/maps/` 下是 `camp.json`，则复制为 `areas/camp/floor_1.json` (需适配格式)。
            *   若 `assets/maps/` 结构已经是 `camp/floor_1.json`，则直接复制。
    *   **继续游戏模式**:
        1.  读取 `meta.json`。
        2.  加载 `PlayerData`。
        3.  准备进入游戏场景。

### 4.3 地图加载逻辑

当玩家进入某区域 (Area) 的某层 (Floor) 时：

1.  构建路径: `saves/game_saves/<save_name>/areas/<area_id>/floor_<level>.json`。
2.  **检查文件是否存在**:
    *   **存在**: 直接加载文件内容，反序列化为 `LayerData`，构建游戏世界。
    *   **不存在**: 触发 **生成逻辑**。
        *   根据 `area_id` 和 `level` 调用 `DungeonGenerator`。
        *   生成新的 `LayerData`。
        *   (可选) 立即保存到磁盘，或等待保存时机。建议生成后暂存内存，离开或保存时写入。

## 5. 编辑器重构

### 5.1 模式选择

*   **开发模式 (Internal)**:
    *   编辑对象：`assets/maps/` 下的文件。
    *   用于制作游戏内置的固定区域（如营地、Boss房、特殊解谜层）。
    *   保存时直接写入 `assets/maps/` (注意：打包后无法写入，此模式仅限开发环境)。

*   **修改模式 (Local)**:
    *   编辑对象：`saves/game_saves/<save_name>/areas/` 下的文件。
    *   先选择存档，再选择区域。
    *   用于修改玩家存档，或测试生成的地图。

### 5.2 多层编辑功能

*   UI 面板增加层级管理：
    *   显示当前区域的所有层列表 (e.g., "Level 1", "Level 5", "Level 10")。
    *   **添加层**: 输入层号，创建一个空白层或生成层。
    *   **删除层**: 删除选中层的数据。
    *   **切换层**: 点击列表项切换当前编辑视图。

### 5.3 数据压缩与存储

*   编辑器保存时，将 `Tile[][]` 转换为 `LayerData` 的压缩格式 (String arrays)。
*   固定两层结构：
    *   **Ground Layer**: 存放 Floor 类型。
    *   **Block Layer**: 存放 Wall, Decor, Interactive 等类型。
    *   **Entities**: 独立列表。
    *   **Items**: 独立列表。

## 6. 验证清单

- [ ] **数据结构**: `SaveData`, `PlayerData`, `LayerData` 类定义完成且能正确 JSON 序列化/反序列化。
- [ ] **AssetUtils**: 确认能正确扫描 `assets/maps/` 下的文件。
- [ ] **新游戏流程**:
    - [ ] 创建存档目录成功。
    - [ ] `meta.json` 和 `player.json` 生成正确。
    - [ ] `assets/maps/` 文件成功复制到存档目录。
- [ ] **加载界面**: Spine 动画播放正常，不阻塞后台加载任务。
- [ ] **地图加载**:
    - [ ] 优先加载存档文件测试通过。
    - [ ] 文件不存在时自动生成测试通过。
    - [ ] 混合模式 (部分层有文件，部分层无) 测试通过。
- [ ] **编辑器**:
    - [ ] Internal 模式能读取/保存 `assets` 文件。
    - [ ] Local 模式能读取/保存 `saves` 文件。
    - [ ] 多层切换和增删功能正常。
    - [ ] 保存的数据格式符合压缩要求。

## 7. 更新计划

1.  **Phase 1: 核心数据与IO**
    *   定义数据类。
    *   实现 `SaveManager` (支持目录结构)。
    *   实现 `MapIO` (支持压缩格式读写)。
2.  **Phase 2: UI 与流程**
    *   制作 `NewGameDialog`, `LoadGameDialog`。
    *   制作 `LoadingScreen` (集成 Spine)。
    *   修改 `MainMenuScreen` 逻辑。
3.  **Phase 3: 地图与生成器适配**
    *   修改 `DungeonLoader` 适配新逻辑。
    *   修改 `DungeonGenerator` 适配新数据结构。
4.  **Phase 4: 编辑器升级**
    *   重构 `CampEditorScreen` (建议更名为 `WorldEditorScreen`)。
    *   实现多层管理 UI。

