# 简易营地编辑器 (CampEditor) 设计方案

## 1. 概述
本方案旨在创建一个用于测试和编辑营地场景的工具 (`CampEditorScreen`)。该场景将结合 `DualGrid` 地图系统与可视化编辑器 UI，允许开发者在运行时动态构建地形、投放生物与物品，以验证游戏内容。

## 2. 核心参考
*   **UI 交互框架**: 参考 `PolyBatchTestScreen`。
    *   布局：左右分栏 (SplitPane)。左侧为所见即所得的编辑/游戏区域 (GameArea)，右侧为属性与工具面板 (Inspector/Tool Panel)。
    *   渲染：使用 `ScissorStack` 限制渲染区域在 GameArea 内。
*   **地图系统**: 参考 `DualGridDemoScreen`。
    *   数据结构：`GridData` (多层网格)。
    *   渲染器：`DualGridRenderer` (自动处理地形拼接)。

## 3. 详细设计

### 3.1 类结构与复用
为了避免代码重复并验证模块化可行性，将 `DualGridDemoScreen` 中的内部类提取为独立组件。

*   **包路径**: `com.goldsprite.magicdungeon.screens.tests.dualgrid` (位于 examples 模块)
*   **组件**:
    *   `DualGridConfig`: 包含 TILE_SIZE, GRID_W/H 等配置。
    *   `TerrainType`: 地形枚举 (AIR, GRASS, DIRT 等)。
    *   `GridData`: 核心数据层，管理多层 int[][] 数组。
    *   `DualGridRenderer`: 负责计算掩码并绘制 Auto-tiling 贴图。

### 3.2 屏幕类设计 (`CampEditorScreen`)
继承自 `GScreen`。

#### 3.2.1 UI 布局 (Stage)
*   **Root**: `VisTable` (fillParent)
*   **SplitPane**: 水平分割。
    *   **Left (GameArea)**: `VisTable` (背景色填充)。
        *   作为输入监听区域。
        *   作为渲染视口区域。
    *   **Right (Tools)**: `VisTable`。
        *   **Terrain Tools**: 地形刷按钮组 (网格布局) + 橡皮擦。
        *   **Entity Tools**: 实体列表 (ListView)。
        *   **Settings**: 网格显示开关、清理按钮。

#### 3.2.2 渲染与相机 (Render System)
不同于 `PolyBatchTestScreen` 的手动偏移计算，本编辑器将使用独立的 `OrthographicCamera` 对应 GameArea。

*   **GameCamera**: 专门用于 GameArea 的场景渲染，支持独立缩放和平移。
*   **渲染流程**:
    1.  绘制 UI (Stage)。
    2.  计算 GameArea 的屏幕坐标 (Scissor Region)。
    3.  `batch.flush()`。
    4.  开启裁剪 (`ScissorStack`)。
    5.  设置 `glViewport` 到 GameArea 区域 (配合 `HdpiUtils`)。
    6.  设置 `batch` 投影矩阵为 `GameCamera.combined`。
    7.  绘制地图 (DualGridRenderer)。
    8.  绘制实体 (ShapeRenderer / Texture)。
    9.  绘制编辑辅助线 (Grid)。
    10. 恢复 `glViewport` 并关闭裁剪。

#### 3.2.3 数据模型 (EditorContext)
除了 `GridData`，新增 `EditorData` 管理动态对象。

*   `List<EditorEntity> entities`: 存储投放的物品/生物。
*   `EditorEntity`: 基础类，包含 `x, y, type`。
*   `EntityType`: 枚举 (PLAYER, ENEMY_SLIME, ITEM_POTION 等)。

### 3.3 交互逻辑
*   **InputProcessor**: `EditorInputHandler`。
    *   检测鼠标在 GameArea 内的操作。
    *   坐标转换：`stageToScreen` -> `camera.unproject` (结合 Viewport 设置)。
    *   **左键**: 绘制地形 / 放置实体 (根据当前工具模式)。
    *   **右键**: 拖拽平移相机。
    *   **滚轮**: 缩放相机。

## 4. 验证计划 (Checklist)

- [x] **代码重构验证**: 成功提取 `DualGrid` 相关类到 `dualgrid` 包，且原 `DualGridDemoScreen` 已更新引用。
- [x] **UI 框架搭建**: `CampEditorScreen` 成功实现，显示左右分栏布局，左侧为黑色 GameArea，右侧为工具栏。
- [x] **地图渲染集成**: 在 GameArea 区域内正确渲染 DualGrid 地图，实现了 `ScissorStack` + `glViewport` 组合方案。
- [x] **相机控制验证**: `EditorInputHandler` 实现了右键拖拽平移和滚轮缩放，坐标转换逻辑使用了 `unproject`。
- [x] **投放功能原型**: 实现了 `EntityType` 枚举与 `EditorEntity` 类，UI 面板可选择实体，点击地图可生成对应颜色的圆形标记。

## 5. 总结
本方案已完成基础实现，构建了一个灵活的测试环境。
- 复用了 `DualGrid` 系统。
- 实现了独立的编辑器视图控制。
- 支持地形绘制与简单的实体投放。
该 Screen 可直接用于测试营地场景的构建与交互。
