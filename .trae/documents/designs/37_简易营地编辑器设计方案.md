# 简易营地编辑器 (CampEditor) 设计方案

## 1. 概述
本方案旨在创建一个用于测试和编辑营地场景的工具 (`CampEditorScreen`)。该场景将结合 `DualGrid` 地图系统与可视化编辑器 UI，允许开发者在运行时动态构建地形、投放生物与物品，以验证游戏内容。

## 2. 核心参考
*   **UI 交互框架**: 参考 `PolyBatchTestScreen`。
    *   布局：左右分栏 (SplitPane)。左侧为所见即所得的编辑/游戏区域 (GameArea)，右侧为属性与工具面板 (Inspector/Tool Panel)。
    *   渲染：使用 `ScissorStack` 限制渲染区域在 GameArea 内。
*   **地图系统**: 使用真实游戏渲染器 `DualGridDungeonRenderer`。
    *   数据结构：`Dungeon` (真实游戏数据结构)。
    *   渲染器：`DualGridDungeonRenderer` (真实游戏渲染效果)。

## 3. 详细设计

### 3.1 类结构与复用
直接复用游戏核心类，不再依赖 `screens.tests.dualgrid` 下的测试类。

*   **核心类引用**:
    *   `com.goldsprite.magicdungeon.world.Dungeon`: 地图数据容器。
    *   `com.goldsprite.magicdungeon.core.renderer.DualGridDungeonRenderer`: 地图渲染器。
    *   `com.goldsprite.magicdungeon.entities.Monster`: 怪物实体。
    *   `com.goldsprite.magicdungeon.entities.Item`: 物品实体。

### 3.2 屏幕类设计 (`CampEditorScreen`)
继承自 `GScreen`。

#### 3.2.1 UI 布局 (Stage)
*   **Root**: `VisTable` (fillParent)
*   **SplitPane**: 水平分割。
    *   **Left (GameArea)**: `VisTable` (背景色填充)。
        *   作为输入监听区域。
        *   作为渲染视口区域。
    *   **Right (Tools)**: `VisTable`，嵌套 `HoverFocusScrollPane` 以支持滚动。
        *   **Tile Tools**: 显示所有 `TileType` (Floor, Wall, Decor等) 的网格选择器。
        *   **Entity Tools**: 
            *   **Monster**: 网格布局，显示所有 `MonsterType` 图标。
            *   **Item**: 网格布局，显示所有 `ItemData` 图标。
        *   **Settings**: 网格显示开关、清理按钮。

#### 3.2.2 渲染与相机 (Render System)
使用 `DualGridDungeonRenderer` 进行真实渲染，但剥离游戏逻辑。

*   **GameCamera**: 专门用于 GameArea 的场景渲染。
*   **渲染流程**:
    1.  绘制 UI (Stage)。
    2.  计算 GameArea 的屏幕坐标 (Scissor Region)。
    3.  `batch.flush()`。
    4.  开启裁剪 (`ScissorStack`)。
    5.  设置 `glViewport` 到 GameArea 区域。
    6.  设置 `batch` 投影矩阵为 `GameCamera.combined`。
    7.  **绘制地图**: `dungeonRenderer.render(batch, dungeon)`。
    8.  **绘制实体**:
        *   遍历 `Dungeon` 中的 `monsters`, `items` 列表（或编辑器维护的实体列表）。
        *   Monster: 若为 `Wolf` 则调用 `SpineRenderer`，否则绘制纹理。
        *   Item: 调用 `ItemRenderer.drawItem`。
    9.  绘制编辑辅助线 (Grid)。
    10. 恢复 `glViewport` 并关闭裁剪。

#### 3.2.3 数据模型 (EditorContext)
*   `Dungeon dungeon`: 核心数据对象，包含 `Tile[][] map`, `List<Monster>`, `List<Item>`。
*   `EditorEntity`: (可选) 仅作为 UI 选中项的数据包装，实际数据直接操作 `Dungeon` 对象。

### 3.3 交互逻辑
*   **InputProcessor**: `EditorInputHandler`。
    *   **左键**: 
        *   Tile模式: `dungeon.setTile(x, y, new Tile(selectedTileType))`。
        *   Entity模式: `dungeon.monsters.add(...)` 或 `dungeon.items.add(...)`。
    *   **右键**: 拖拽平移相机。
    *   **滚轮**: 缩放相机。

## 4. 验证计划 (Checklist)

- [x] **UI 框架搭建**: 左右分栏布局与 GameArea 裁剪。
- [ ] **真实渲染集成**:
    - [ ] 替换 `GridData` 为 `Dungeon`。
    - [ ] 替换 `DualGridRenderer` 为 `DualGridDungeonRenderer`。
    - [ ] 实现 Monster/Item 的真实渲染逻辑 (逻辑分离)。
    - [ ] 集成 Spine 渲染 (Wolf)。
- [ ] **UI 改进**:
    - [ ] 确保 `HoverFocusScrollPane` 覆盖所有工具面板，解决溢出问题。
    - [ ] 提供所有 `TileType`, `MonsterType`, `ItemData` 的网格选择器。


## 5. 总结
本方案已完成基础实现，构建了一个灵活的测试环境。
- 复用了 `DualGrid` 系统。
- 实现了独立的编辑器视图控制。
- 支持地形绘制与简单的实体投放。
该 Screen 可直接用于测试营地场景的构建与交互。
