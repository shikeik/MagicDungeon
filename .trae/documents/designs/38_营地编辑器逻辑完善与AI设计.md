# 38_营地编辑器逻辑完善与AI设计

## 1. 概述
本方案旨在完善营地编辑器 (`CampEditorScreen`) 的功能，使其与游戏世界逻辑更一致，并增强实体的 AI 行为。主要包含两部分：多层地图编辑支持、AI 闲逛逻辑与逻辑开关。

## 2. 地图层级系统 (Map Layers)

### 2.1 需求分析
用户指出当前的“单层”逻辑不符合预期，需要恢复类似 `DualGridDemo` 的多层地图逻辑。
*   **结构一致性**: 编辑器应包含“地图层”、“物品层”、“实体层”三大顶级分类。
*   **多层地图**: 地图层内部应支持任意数量的子层 (Layer 0, Layer 1, ...)，且支持动态添加/删除。
*   **渲染复用**: 继续使用真实渲染器 `DualGridDungeonRenderer`，但需适配多层数据结构。

### 2.2 数据结构设计
在 `CampEditorScreen` 中重构数据模型：

```java
public class CampEditorScreen extends GScreen {
    // ...
    
    // 地形层数据 (替代单一的 Dungeon.map)
    // 每一层都是一个完整的二维数组，存储该层的 Tile 信息
    private List<Tile[][]> mapLayers = new ArrayList<>();
    private int selectedMapLayerIndex = 0;

    // 实体与物品数据 (保持独立)
    private List<Monster> monsters = new ArrayList<>();
    private List<Item> items = new ArrayList<>();

    // 渲染上下文 (用于欺骗 DualGridDungeonRenderer)
    private Dungeon renderProxyDungeon;
}
```

### 2.3 渲染流程适配
由于 `DualGridDungeonRenderer` 绑定了 `Dungeon` 对象，我们需要在渲染循环中动态替换 `Dungeon.map`：

1.  **遍历 `mapLayers`**:
    *   将 `renderProxyDungeon.map` 指向当前层的 `Tile[][]`。
    *   调用 `dungeonRenderer.render(batch, renderProxyDungeon)`。
2.  **渲染实体与物品**:
    *   在所有地形层渲染完毕后，统一渲染 `items` 和 `monsters`。

### 2.4 UI 交互调整
右侧工具栏重构为 Accordion (手风琴) 或 Tab 风格，或者保留垂直布局但增加层级控制：

*   **Map Layers (Group)**
    *   [Layer List / SelectBox]
    *   [Add Layer] [Remove Layer]
    *   [Tile Palette (Grid)]
*   **Items (Group)**
    *   [Item Palette]
*   **Entities (Group)**
    *   [Monster Palette]

## 3. 实体 AI 增强

### 3.1 闲逛逻辑 (Wander)
在 `Monster` 类中增加状态机。

*   **状态定义**: `IDLE`, `WANDER`, `CHASE`.
*   **闲逛行为**:
    *   定时器触发 (随机 2-5秒)。
    *   随机选取半径 R 内的一个可走点 (Walkable Check)。
    *   若目标点不可走或有障碍，重试或放弃。
    *   移动到目标点。
*   **追击行为 (Override)**:
    *   每帧检测玩家距离。
    *   若 < AggroRange，强制切换为 `CHASE` 状态。
    *   若 > GiveUpRange，切换回 `IDLE/WANDER`。

### 3.2 逻辑控制
在编辑器 UI 中增加“世界逻辑”开关：
*   **Toggle Button**: "World Logic: ON/OFF".
*   **OFF**: 实体静止，仅渲染。
*   **ON**: 调用 `monster.update()`，启用 AI。

## 4. 实现步骤

1.  **AI 实现**: 修改 `Monster.java`，添加 `Wander` 逻辑与状态管理。
2.  **编辑器数据重构**: 将 `CampEditorScreen` 的单一 `Dungeon` 改为 `List<Tile[][]>` 结构。
3.  **编辑器 UI 重构**: 
    *   添加层级管理 UI (参考 `DualGridDemoScreen`)。
    *   添加逻辑开关按钮。
4.  **渲染循环调整**: 实现多层 map 的循环渲染。
5.  **验证**: 测试多层叠加效果、测试 AI 闲逛与追击切换。
