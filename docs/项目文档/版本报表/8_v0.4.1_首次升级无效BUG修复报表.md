# v0.4.1 首次升级无效BUG修复报表

> 日期：2026-03-01  
> 版本：v0.4.1  
> 类型：BUG 修复

---

## 一、现象

1. 经验条从 0/83 满后，经验归零、上限变为 0/100
2. **等级没有提升**（仍显示 Lv.1）
3. 再次攒满 100 经验后，升级正常触发（变为 Lv.2）

即：**首次升级被"吃掉"了**。

---

## 二、代码链追踪

### 2.1 玩家创建

```
EnemyDefs.createPlayer()
  → new GameEntity(4, 4, "player", 100, 12, 5, 0.2f, 0, MELEE)
    → GameEntity构造函数:
        this.totalXp = 0;           // ← 总经验 = 0
        stats.setLevel(1);          // ← 等级 = 1  ⚠️ 矛盾点！
```

**问题**：根据 `GrowthCalculator.levelFromXp(0) = 0`，0 经验对应的是 **0 级**，但构造函数把等级硬设为 **1 级**。

### 2.2 经验条显示

```
GameRenderer.drawHud():
  xpProg = GrowthCalculator.xpProgress(player.totalXp)
  显示: Lv.{player.stats.getLevel()} | XP:{xpProg[0]}/{xpProg[1]}
```

- `xpProgress(0)` → `[0, 83]`（0→1 级需要 83 经验，当前进度 0）
- 此时 `stats.getLevel() = 1`，**显示 Lv.1 但经验条显示的是 0→1 级的进度**

### 2.3 击杀升级判定

```
GrowthHelper.onEnemyKilled():
  player.totalXp += enemy.xpReward;     // totalXp 增加
  oldLevel = player.stats.getLevel();    // = 1（构造函数设的）
  newLevel = GrowthCalculator.levelFromXp(player.totalXp);  // 经验推导的等级

  if (newLevel > oldLevel) → 升级！
```

### 2.4 BUG 触发时序（以首次积累 83 XP 为例）

| 步骤 | totalXp | stats.level | levelFromXp() | 条件 newLevel > oldLevel | 结果 |
|---|---|---|---|---|---|
| 初始 | 0 | 1 | 0 | — | 等级=1，经验条 0/83 |
| 积累到 83 | 83 | 1 | **1** | 1 > 1 = **false** | ❌ 升级未触发！经验条变 0/100 |
| 积累到 183 | 183 | 1 | **2** | 2 > 1 = **true** | ✅ 升级触发，等级→2 |

**根因**：`stats.level` 初始化为 1，而 `totalXp` 初始化为 0。两个数据源不一致，导致首次升级时 `levelFromXp(83) = 1 = stats.getLevel()`，条件不满足。

---

## 三、修复方案

**将 `GameEntity` 构造函数中的 `stats.setLevel(1)` 改为 `stats.setLevel(0)`**，使等级与经验保持一致（0 经验 = 0 级）。

同时修正 `fixedPointsPerStat` 参数为 0，确保 equipFixed 反推正确。

### 修复后数据验证

| 步骤 | totalXp | stats.level | levelFromXp() | 条件 | 结果 |
|---|---|---|---|---|---|
| 初始 | 0 | **0** | 0 | — | 等级=0，经验条 0/83 |
| 积累到 83 | 83 | 0 | **1** | 1 > 0 = **true** | ✅ 升级触发！等级→1 |
| 积累到 183 | 183 | 1 | **2** | 2 > 1 = **true** | ✅ 升级触发！等级→2 |

### 属性影响分析

`fixedPointsPerStat(0) = 1`, `fixedPointsPerStat(1) = 2`。

构造函数中 `equipFixed = hp参数 - fixedPts × valuePerPoint`：
- 修复前 (level=1): `equipFixed(HP) = 100 - 2×20 = 60`  →  最终 HP = (2+0)×20+60 = 100
- 修复后 (level=0): `equipFixed(HP) = 100 - 1×20 = 80`  →  最终 HP = (1+0)×20+80 = 100

**初始属性值完全不变**（equipFixed 自动补偿），修复无副作用。

---

## 四、涉及文件

| 文件 | 改动 |
|---|---|
| `GameEntity.java` | `stats.setLevel(1)` → `stats.setLevel(0)`，`fixedPointsPerStat(1)` → `fixedPointsPerStat(0)` |
