# v0.4.0 版本报表 — 联机模块分层与依赖切换

**日期**: 2026-02-22  
**版本**: 0.4.0 (开发中)  
**主题**: TestNetty 纯框架化 + MagicDungeon2 业务联机下沉

---

## 概述

本次更新完成了联机能力的分层修正：

- 将 TestNetty 明确为“通用网络框架层”，不承载业务协议与业务处理；
- 将局域网联机业务协议与处理逻辑迁回 MagicDungeon2 网络模块；
- 将 TestNetty 依赖切换到正式版坐标并与包名一致（非 snapshot）。

---

## 变更清单

### 1. 依赖坐标切换（正式版）

- `core/build.gradle` 中依赖从旧坐标调整为：
  - `goldsprite.myUdpNetty:TestNetty:0.8.0`

### 2. 局域网业务协议迁入项目侧

新增业务协议与模型（项目侧定义，避免污染库层）：

- `LanCommands`
- `LanPlayerStateSnapshot`
- `LanPlayerSyncRequestPacket`
- `LanPlayerSyncBroadcastPacket`
- `LanRoomPlayersRequestPacket`
- `LanRoomPlayersResponsePacket`

路径：
- `core/src/main/java/com/goldsprite/magicdungeon2/network/lan/packet/`

### 3. 联机服务重构（业务下沉）

`LanMultiplayerService` 已改为：

- 在业务层注册业务包到 TestNetty 编解码器（动态注册）；
- 业务层自管房间玩家快照与同步广播逻辑；
- 通过 TestNetty 的通用订阅扩展点收发业务包。

### 4. 联机测试入口保持可用

- 保留局域网联机测试屏（用于开房/加入/同步验证）；
- 联机链路改为“业务协议在项目侧，框架能力在库侧”。

---

## 涉及文件

| 文件 | 变更类型 |
|---|---|
| `core/build.gradle` | 依赖坐标更新 |
| `core/src/main/java/com/goldsprite/magicdungeon2/network/lan/LanMultiplayerService.java` | 联机服务重构 |
| `core/src/main/java/com/goldsprite/magicdungeon2/network/lan/packet/*.java` | 新增业务协议与模型 |

---

## 验证结果

- **依赖解析**: 已解析 `goldsprite.myUdpNetty:TestNetty:0.8.0`
- **编译**: `:core:compileJava` 通过
- **兼容性**: 保持原有联机测试入口可继续验证

---

## 后续建议

- 增加“联机扩展协议模板”文档，统一后续业务包命名与注册流程；
- 补充局域网联机场景自动化回归（最小连接/同步/断线重连流程）。
