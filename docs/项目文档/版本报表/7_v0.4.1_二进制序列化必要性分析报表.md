# v0.4.1 二进制序列化必要性分析报表

> 日期：2026-03-01  
> 版本：v0.4.1  
> 类型：性能分析 / 决策记录

---

## 一、背景

当前联机同步使用 Gson JSON 序列化 `LanPlayerStateSnapshot`，考虑是否需要替换为二进制序列化（ByteBuf / Protobuf / Kryo）以降低延迟。

---

## 二、当前包体大小实测

一个 `LanPlayerStateSnapshot` 的 JSON 示例：
```json
{"playerGuid":12345,"playerName":"Player1","x":123.45,"y":789.01,"vx":1.5,"vy":-2.3,"action":"idle","timestamp":1709280000000}
```

| 格式 | 包体大小 | 含 UDP/IP 头 + 帧头 |
|---|---|---|
| JSON (当前) | ~130-160 字节 | ~200 字节 |
| 二进制 (ByteBuf) | ~40-50 字节 | ~80 字节 |

---

## 三、传输延迟对比

**传输延迟 = 包体大小 ÷ 上行带宽**

| 网络类型 | 上行带宽 | 200B (JSON) | 50B (二进制) | 差值 |
|---|---|---|---|---|
| 家庭宽带 (10Mbps) | 10Mbps | 0.016ms | 0.004ms | **0.012ms** |
| 4G 较差 (1Mbps) | 1Mbps | 0.16ms | 0.04ms | **0.12ms** |
| 最烂 WiFi (500Kbps) | 500Kbps | 0.32ms | 0.08ms | **0.24ms** |

对比网络 RTT 本身 ≈ **100ms**，传输延迟差异 **不到 0.25ms，差了近 1000 倍，完全可以忽略**。

---

## 四、带宽占用估算

60Hz 同步，4 人房间（服务器需向每人转发其余 3 人数据）：

| 格式 | 单玩家上行 | 服务器下行 (4人) | 总计 |
|---|---|---|---|
| JSON | 60×200B = 12KB/s | 60×3×200B = 36KB/s | ~48KB/s ≈ 384Kbps |
| 二进制 | 60×80B = 4.8KB/s | 60×3×80B = 14.4KB/s | ~19KB/s ≈ 152Kbps |

即使是 JSON 格式，384Kbps 对任何网络环境都毫无压力。

---

## 五、二进制序列化有价值的场景

| 场景 | 是否需要 | 说明 |
|---|---|---|
| 大规模多人 (50+同屏) | 需要 | 服务器每秒 50×60×200B = 600KB/s |
| 同步大量数据 (地图/怪物) | 需要 | 单包可能达到 KB 级 |
| 服务端 CPU 瓶颈 (百人并发) | 需要 | Gson 反射开销在高并发下显著 |
| **4人地牢探索 (当前)** | **不需要** | 包小、人少、带宽充裕 |

---

## 六、结论

**不改。** 原因：
1. 200 字节的包在 100ms RTT 面前传输延迟差异仅 0.12ms，对延迟影响为零
2. 48KB/s 的总带宽消耗对任何网络都不构成负担
3. JSON 可读性高，方便调试抓包
4. 延迟优化的精力应放在 **插值 / 外推算法** 上，能把 200ms 体感降到 ~50ms，收益大得多

**后续如果出现以下情况再考虑**：
- 同屏玩家数超过 10+
- 需要高频同步大数据（完整地图状态、大量怪物 AI 等）
- 服务器 CPU 出现瓶颈
