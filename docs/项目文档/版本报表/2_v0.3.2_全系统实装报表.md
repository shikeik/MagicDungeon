# v0.3.2 版本报表 — 全系统实装

**日期**: 2026-02-22
**版本**: 0.3.2 (未发布)
**主题**: 将所有 @Deprecated 核心系统接入游戏循环，视口统一迁移

---

## 概述

本次更新将 v0.2.0 建立的 6 大核心数据模型（72 个单元测试）从"纸上谈兵"状态全部接入游戏运行时。
此前约 70% 的核心代码虽有完整测试覆盖，但从未在游戏中实际调用。本版本彻底解决这一问题。

---

## 变更清单

### 1. 视口统一迁移

| 项目 | 变更前 | 变更后 |
|---|---|---|
| batch | SimpleGameScreen 自建 `NeonBatch` | 使用 GScreen 继承的 `batch` |
| camera | 自建 `OrthographicCamera` | 使用 `getWorldCamera()` |
| viewport | 自建 `ExtendViewport(400,400)` | 世界渲染用 `worldCamera`，HUD 用 `getUIViewport()` |
| resize | `viewport.update()` | `super.resize()` 委托 GScreen |
| dispose | 手动 dispose batch | GScreen 统一管理 |

- 重写 `resizeWorldCamera()` 保持 400px 等比视野
- `render()` → `render0()`，由 GScreen 生命周期驱动
- HUD 投影矩阵从 `setToOrtho2D(屏幕像素)` 改为 `getUICamera().combined`
- VirtualControlsOverlay 视口同步使用 `getUIViewport()` 尺寸

### 2. 经验与升级系统（激活 GrowthCalculator）

- Entity 新增字段: `totalXp`(long), `gold`(int), `xpReward`(int)
- 敌人 XP 奖励: slime=15, bat=20, skeleton=25, wolf=30
- 金币奖励 = XP/2
- 击杀敌人 → `GrowthCalculator.levelFromXp()` 推导等级
- 升级触发: `stats.setLevel()` + 自由点自动均匀分配 HP/ATK/DEF + 满血/满MP恢复
- 升级金色飘字 "升级! Lv.X"
- HUD 显示: `Lv.X | XP: 当前/升级需要`

### 3. 死亡惩罚系统（激活 DeathPenalty）

- 玩家死亡 → `DeathPenalty.calcPenalty(totalXp, gold)` 计算惩罚
- `DeathPenalty.applyLevelLoss()` 处理降级自由点均匀扣除
- 惩罚内容: 经验-20%, 金币-50%(可拾回40%), 等级可能回落
- 重生后保留扣减后的进度（XP/金币/等级），不再完全重置

### 4. 死亡重生UI覆盖层

- 半透明黑色背景 + 居中信息面板
- 显示内容: 经验损失、等级变化(降级才显示)、金币掉落(含可拾回数额)
- 按 R 键重生: 重建地图+敌人，玩家位置重置，HP/MP 回满

### 5. MP系统（激活 StatData.getMP）

- Entity 新增 `mp` 字段，`getMaxMp()` 委托 `stats.getMP()`
- 自然回复: 每秒 5% 最大MP
- 魔法攻击: 按 J 键(ATTACK)，消耗 10MP
- 沿面朝方向发射，射程 5 格(WeaponRange.ENERGY)，无穿透
- 伤害计算: `CombatEngine.calcMagicDamage(ATK, MDEF)`
- MP 不足时显示蓝色飘字 "MP不足"
- 魔法伤害飘字: 紫色

### 6. MOV系统（激活 StatData.getMOV）

- 冷却拆分为两种:
  - `getMoveCooldown()` = `moveDelay / MOV` — 移动频率
  - `getAttackCooldown()` = `moveDelay / ASP` — 攻击频率
- 替换所有 `getEffectiveCooldown()` 调用

### 7. 魔法伤害类型（激活 DamageType）

- 物理 Bump 攻击 → `calcPhysicalDamage(ATK, DEF)` → 黄色飘字
- 魔法攻击 → `calcMagicDamage(ATK, MDEF)` → 紫色飘字
- MDEF = DEF / 2，魔法更容易破防

### 8. 武器范围系统（激活 WeaponRange）

- Entity 新增 `weaponRange` 字段
- 敌人武器分配: skeleton=POLEARM(2格穿透), 其余=MELEE(1格)
- 统一攻击判定 `performRangedAttack()`: 沿方向扫描 range 格，遇墙阻挡
- 敌人远程AI `tryAttackPlayer()`: 四方向射程内检测玩家，可原地攻击

### 9. 穿透伤害系统（激活 CombatEngine.calcPierce*）

- 穿透武器命中路径上所有目标
- 伤害衰减: `calcPierceDamage(baseDmg, index)` — 每目标保留 70%
- 低于 0.1 阈值归零
- 穿透飘字: 橙色（区别于首目标黄色）

---

## @Deprecated 标记移除

### 类级别
- `GrowthCalculator` — 经验升级已接入
- `DeathPenalty` — 死亡惩罚已接入
- `DamageType` — 魔法伤害已接入
- `WeaponRange` — 武器范围已接入

### 方法级别
- `CombatEngine.calcPhysicalDamage()` — 物理攻击路径使用
- `CombatEngine.calcMagicDamage()` — 魔法攻击路径使用
- `CombatEngine.calcPierceDamage()` — 穿透衰减路径使用
- `CombatEngine.calcPierceAllDamages()` — 穿透全路径计算可用
- `StatData.getMP()` — MP 系统已接入
- `StatData.getMDEF()` — 魔法伤害计算使用
- `StatData.getMOV()` — 移动冷却计算使用

---

## 涉及文件

| 文件 | 变更类型 |
|---|---|
| `SimpleGameScreen.java` | 重构 (视口迁移 + 9大系统全部接入) |
| `GrowthCalculator.java` | 移除 @Deprecated |
| `DeathPenalty.java` | 移除 @Deprecated |
| `DamageType.java` | 移除 @Deprecated |
| `WeaponRange.java` | 移除 @Deprecated |
| `CombatEngine.java` | 移除 4个方法的 @Deprecated |
| `StatData.java` | 移除 3个方法的 @Deprecated |

---

## 验证结果

- **编译**: BUILD SUCCESSFUL
- **单元测试**: 72/72 PASSED (StatData×22, CombatEngine×19, GrowthCalculator×16, DeathPenalty×10, 其余×5)
- **零破坏性变更**: 所有核心数据模型的测试未受影响

---

## 遗留事项

- 自由点分配目前为自动均匀，后续需加属性分配 UI
- 金币/装备掉落目前为纯数值扣减，后续需加地面拾取机制
- 楼梯换层后保留玩家进度，但敌人不会变强（需加层级难度递增）
- 魔法攻击目前复用 ATK 作为魔法攻击力，后续可独立 MATK 属性
