# v0.4.1 广域网联机方案分析报表

> 日期：2026-03-01  
> 版本：v0.4.1  
> 类型：架构分析 / 方案对比

---

## 一、背景

当前联机模块基于局域网 UDP 实现（`LanMultiplayerService`），采用 C/S 架构（Host = Server + Client）。最终目标是支持广域网联机，预估 RTT ≈ 100ms，往返可见延迟 ≈ 200ms。需要解决两个核心问题：

1. **降低延迟体感** —— 在 200ms RTT 下让操作不卡顿
2. **广域网可达性** —— NAT 穿透 / 中继，让互联网上的玩家能连上

---

## 二、P2P vs C/S 架构对比（结论：不改）

| 维度 | C/S（当前） | P2P |
|---|---|---|
| LAN RTT | 2-10ms | 1-5ms |
| WAN RTT | 100ms（经中继） | 40-100ms（直连） |
| 连接复杂度 | O(N)，所有人连 Server | O(N²)，两两互连 |
| 房间管理 | Server 统一管理 | 需选举 / 额外协调 |
| 未来扩展 | 天然支持服务端权威 | 难加反作弊 |
| 架构改动量 | 无需改动 | 需要重写网络层 |

**结论**：C/S relay 模型天然就是广域网中继架构的雏形，不需要改成 P2P。

---

## 三、延迟拆解

广域网场景下（单程 100ms）：

| 延迟环节 | 耗时 | 说明 |
|---|---|---|
| 玩家A操作 → 服务器 | ~100ms | 上行 |
| 服务器广播 → 玩家B | ~100ms | 下行 |
| **总可见延迟** | **~200ms** | A的操作到B看见的延迟 |
| 本地操作反馈 | **0ms** | 本地立即执行 |

当前架构"自己的操作本地立即执行，远程玩家位置做插值"，玩家自身体验是 0ms 延迟的，200ms 只影响看到对方移动的延迟。

---

## 四、降延迟手段（不改架构）

### 4.1 提升同步频率到 60Hz ✅ 已完成

`syncIntervalMs` 从 50ms(20Hz) 改为 16ms(≈60Hz)，让远程位置数据更密，插值更丝滑。

### 4.2 启用 NetworkTransform 快照插值

已有 `NetworkTransform`（双快照 + 80ms 延迟缓冲），但 `SimpleGameScreen` 未使用。启用后：
- 平滑远程玩家运动轨迹
- 消除抖动（jitter）
- 代价：增加 80ms 表现延迟，但视觉更平滑

### 4.3 客户端速度外推（Extrapolation）

对远程玩家，收到位置包时根据速度外推未来位置：
```
预测位置 = 最新位置 + 速度 × (当前时间 - 包时间戳)
```
能"抵消"约一半的可见延迟。`LanPlayerStateSnapshot` 已有 `vx, vy, timestamp`，天然支持。

### 4.4 各手段效果估算

| 优化手段 | 视觉延迟 (WAN) | 平滑度 |
|---|---|---|
| 无优化 (原始 Lerp) | ~200ms | 差，卡顿 |
| 启用 NetworkTransform 插值 | ~250ms（+80ms缓冲） | 好，丝滑 |
| 速度外推 | ~50ms | 好，偶尔抖 |
| 插值 + 外推结合 | ~80ms | 最优 |

---

## 五、广域网可达性方案

### 5.1 核心问题

| 问题 | 说明 |
|---|---|
| NAT 穿透 | 家庭路由器阻止外部直连，两端都在 NAT 后 |
| IP 不可知 | 玩家不知道对方的公网 IP |
| 防火墙 | 运营商/路由可能屏蔽 UDP |

### 5.2 方案矩阵

| 方案 | 复杂度 | 延迟 | 成本 | 适合阶段 |
|---|---|---|---|---|
| **A. 中继服务器 (Relay)** | ★★☆ | +50-100ms | 需要云服务器 | 最先做 |
| **B. NAT 穿透 (UDP Hole Punching)** | ★★★★ | 最低 | 需 STUN/TURN | 中期优化 |
| **C. 第三方虚拟局域网** | ★☆☆ | 中等 | 免费/付费 | 快速验证 |

### 5.3 方案 A：中继服务器（推荐先做）

```
玩家A ──UDP──→ [云服务器:Relay] ──UDP──→ 玩家B
```

- TestNetty Server 代码几乎可以直接部署到云
- 当前 C/S 架构天然支持，不需要改网络层
- 延迟 = A到服务器 + 服务器到B ≈ 50+50 = 100ms（国内同区机房）
- 成本：最便宜的云服务器 1 核 1G ≈ 30-50 元/月

**改动点**：
1. Host 不再本地起 Server，改为连接远程 Server
2. 房间管理逻辑从 Host 提取到 Server
3. 通过房间号/邀请码加入，替代 UDP 广播发现

### 5.4 方案 B：NAT 穿透

```
玩家A ──→ [STUN Server] ←── 玩家B
         (交换公网地址)
玩家A ←──UDP 直连──→ 玩家B
```

- 成功率约 70-80%（取决于 NAT 类型）
- 失败时回退到 Relay
- 延迟最优，但实现复杂

### 5.5 方案 C：第三方虚拟局域网

- ZeroTier / Tailscale：虚拟局域网，现有 LAN 代码直接能用
- 缺点：需要玩家额外安装软件
- 适合开发/测试阶段快速验证广域网效果

---

## 六、推荐演进路线

```
当前 (LAN C/S)
  │
  ▼ Phase 1: 优化体验 (不改架构)
  ├─ ✅ 60Hz 同步
  ├─ 启用 NetworkTransform 插值
  └─ 加入客户端速度外推
  │
  ▼ Phase 2: 广域网支持 (中继)
  ├─ 将 Server 部署到云端
  ├─ 加入房间号匹配机制
  └─ 替换 UDP 广播发现为 HTTP 房间列表
  │
  ▼ Phase 3: 延迟优化 (可选)
  ├─ STUN/TURN NAT 穿透 (直连优先, 回退中继)
  └─ 服务端权威 (防作弊)
```

---

## 七、关键数字参考

| 指标 | LAN (当前) | WAN Relay | WAN 直连 |
|---|---|---|---|
| RTT | 2-10ms | 80-200ms | 40-100ms |
| 同步频率 | 60Hz ✅ | 60Hz 可行 | 60Hz 可行 |
| 包体 (JSON) | ~200B | 够用 | 够用 |
| 带宽/玩家 (60Hz) | ~12KB/s | 够用 | 够用 |
| 视觉延迟 (插值+外推) | ~10ms | ~80ms | ~40ms |
