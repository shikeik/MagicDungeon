# Netcode v0.6.5 · Despawn 与跨进程 UDP 坦克沙盒报表

## 版本：v0.6.5 · 总代码量 ~3040 行（引擎 1208 + 测试 1023 + 沙盒 809）

---

## 一、本版新增功能总览

| # | 功能 | 说明 |
|---|------|------|
| 1 | **Despawn 网络广播** | `NetworkManager.despawn(netId)` + 0x12 封包 + 双端清理 |
| 2 | **跨进程 UDP 坦克沙盒** | Server/Client 独立屏幕，真实 UDP 通信，状态机驱动 |
| 3 | **共享类提取与沙盒重构** | Bullet、TankBehaviour、TankSandboxUtils 独立文件，消除重复 |
| 4 | **新查询 API** | `getNetworkObjectCount()`、`getAllNetworkObjects()`、`getClientCount()` |
| 5 | **registerPrefab 时序修复** | 工厂注册必须在 connect/startServer 之前，避免异步收包先于工厂 |

---

## 二、Despawn 实现细节

### 封包格式
```
[0x12][4字节 networkId]
```

### 流程
1. Server 调用 `manager.despawn(netId)`
2. 从本地 `networkObjects` 注册表移除
3. 序列化 0x12 封包并 `broadcast()` 给所有 Client
4. Client 收到后自动从本地注册表移除对应实体

### TDD 用例（2 个，全绿）
| 测试 | 验证内容 |
|------|----------|
| `testDespawnRemovesBothSides` | Spawn → Despawn → Server/Client 注册表均清空 |
| `testDespawnDoesNotAffectOtherEntities` | Despawn 实体1 → 实体2 不受影响，同步仍正常 |

---

## 三、跨进程 UDP 坦克沙盒

### 架构设计

```
┌──────────────────────────────┐    UDP 19100    ┌──────────────────────────────┐
│     NetcodeUdpServerScreen   │ ◄════════════► │     NetcodeUdpClientScreen   │
│                              │                 │                              │
│  状态机:                      │   SpawnPacket   │  状态机:                      │
│  WAITING → PLAYING           │   StateSync     │  CONNECTING → PLAYING        │
│                              │   ClientRpc     │                              │
│  · 监听端口, 等待握手         │ ──────────────► │  · 连接, 轮询 SpawnPacket    │
│  · 双人输入 (WASD/方向键)     │                 │  · 接收同步状态              │
│  · 子弹物理 + 碰撞检测       │                 │  · ClientRpc 子弹本地模拟    │
│  · tick() 广播状态           │                 │  · tick() 处理收包           │
│  · 全屏渲染                   │                 │  · 全屏渲染（只读观察）      │
└──────────────────────────────┘                 └──────────────────────────────┘
```

### 使用方式
1. 启动进程 A → 菜单选择「Netcode UDP服务端」→ 等待客户端连接
2. 启动进程 B → 菜单选择「Netcode UDP客户端」→ 自动连接 `127.0.0.1:19100`
3. Server 端操作：P1 = WASD + J | P2 = 方向键 + Enter
4. Client 端实时同步观察

### 状态机设计
- **Server**：`WAITING_FOR_CLIENT` → 检测 `getClientCount() > 0` → Spawn 两辆坦克 → `PLAYING`
- **Client**：`CONNECTING` → 每帧 `tick()` 处理收包 → 检测 `getNetworkObjectCount() >= 2` → 提取引用 → `PLAYING`

### 关键时序修复
```
❌ 旧顺序（触发 Bug）：
   setTransport → connect → registerPrefab
   （收包线程已启动，SpawnPacket 到达时工厂未注册）

✅ 新顺序（正确）：
   setTransport → registerPrefab → connect
   （工厂先就绪，收包线程启动后能正确处理 SpawnPacket）
```

---

## 四、共享类提取与代码复用

### 提取前（重复代码）
- `NetcodeTankSandboxScreen` 内含 `Bullet` 内部类 + `TankBehaviour` 内部类 + 绘制/工厂/子弹/扣血方法

### 提取后（三个独立文件）

| 文件 | 行数 | 职责 |
|------|------|------|
| `Bullet.java` | 12 | 子弹数据类：x, y, vx, vy, ownerId, color |
| `TankBehaviour.java` | 39 | 网络行为组件：7 个 NetworkVariable + ClientRpc |
| `TankSandboxUtils.java` | 93 | 静态工具：工厂创建、子弹生成、扣血、坦克/子弹绘制 |

### 复用关系
```
TankSandboxUtils / TankBehaviour / Bullet
        ▲               ▲              ▲
        │               │              │
  ┌─────┴───┐     ┌─────┴───┐    ┌────┴────┐
  │ 纯内存   │     │ UDP     │    │ UDP     │
  │ 沙盒     │     │ Server  │    │ Client  │
  └─────────┘     └─────────┘    └─────────┘
```

---

## 五、代码量变化

### 与上版对比（v0.6.4 → v0.6.5）

| 层 | v0.6.4 | v0.6.5 | 增量 |
|----|--------|--------|------|
| 引擎（core/netcode） | ~1035 | 1208 | +173（Despawn + 查询 API） |
| 测试（tests） | ~730 | 1023 | +293（DespawnTest + GdxTestRunner/CLogAssert 基础设施） |
| 沙盒（examples/netcode） | ~400 | 809 | +409（UDP 双屏幕 + 共享类提取） |
| **合计** | **~2165** | **~3040** | **+875** |

### 引擎层文件清单（13 个源文件）

| 文件 | 行数 | 变更 |
|------|------|------|
| NetworkManager | 375 | **+** despawn() / getNetworkObjectCount() / getAllNetworkObjects() / 0x12 处理 |
| UdpSocketTransport | 249 | **+** getClientCount() |
| NetworkObject | 119 | — |
| LocalMemoryTransport | 99 | — |
| NetworkBehaviour | 90 | — |
| NetBuffer | 83 | — |
| NetworkVariable | 81 | — |
| RpcScanner | 34 | — |
| Transport | 21 | — |
| TransportReceiveCallback | 15 | — |
| ServerRpc | 15 | — |
| ClientRpc | 14 | — |
| NetworkPrefabFactory | 13 | — |

---

## 六、完整封包协议（5 种）

| 类型 | 字节头 | 格式 | 方向 |
|------|--------|------|------|
| 状态同步 | 0x10 | `[netId][dirtyCount][varIdx,value]...` | Server→Client |
| Spawn | 0x11 | `[netId][prefabId]` | Server→Client |
| **Despawn** | **0x12** | **`[netId]`** | **Server→Client** ← 新增 |
| ServerRpc | 0x20 | `[netId][behaviourIdx][methodName][argCount][args...]` | Client→Server |
| ClientRpc | 0x21 | `[netId][behaviourIdx][methodName][argCount][args...]` | Server→Client |

---

## 七、测试覆盖（32 个用例，全绿）

| 测试文件 | 用例数 | 覆盖内容 |
|----------|--------|----------|
| NetworkVariableTest | 2 | 脏标记检测 |
| NetworkObjectTest | 2 | 对象容器 + 自动装配 |
| NetworkBehaviourReflectionTest | 1 | 反射发现 NetworkVariable |
| NetBufferTest | 1 | 序列化/反序列化 |
| NetworkManagerTest | 2 | 单端 Spawn + tick |
| DualEndpointIntegrationTest | 1 | 双端全链路同步 |
| SpawnAutoDerivationTest | 3 | 预制体自动派生 |
| RpcMethodReflectionTest | 3 | RPC 注解扫描 |
| RpcInvocationTest | 3 | 双向 RPC 调用 |
| UdpSocketTransportTest | 3 | UDP 广播/上行/全链路 |
| **DespawnTest** | **2** | **Despawn 双端清理 + 不影响其它实体** ← 新增 |
| CombatEngineTest | 3 | 战斗引擎 |
| DeathPenaltyTest | 2 | 死亡惩罚 |
| GrowthCalculatorTest | 2 | 成长计算 |
| StatDataTest | 2 | 属性数据 |

---

## 八、版本演进路线

| 版本 | 里程碑 | 报表 |
|------|--------|------|
| v0.6.0 | Netcode 重写：NetworkVariable + NetBuffer + 内存传输 + 沙盒 | #10~#11 |
| v0.6.1 | NetBuffer 自动同步落地 | #12 |
| v0.6.2~v0.6.3 | Spawn 自动派生 + RPC 双向调用 | #13 |
| v0.6.4 | Transport 统一回调 + UDP 真实传输层 | #14~#15 |
| **v0.6.5** | **Despawn + 跨进程 UDP 沙盒 + 共享类重构** | **#16** ← 当前 |

---

## 九、下一步可选方向

| 优先级 | 功能 | 说明 |
|--------|------|------|
| 高 | 客户端输入上行 | Client 通过 ServerRpc 发送操作指令，Server 处理后同步（真正的双端对战） |
| 高 | 断线重连 | 心跳超时 + 重连握手 + 状态全量重同步 |
| 中 | 网络延迟模拟 | LocalMemoryTransport 加可配置延迟，测试弱网表现 |
| 中 | 可靠有序传输 | UDP 上层加序号/确认/重传，防止丢包 |
| 低 | 多客户端支持 | 当前 Server 仅处理第一个 Client，扩展为多 Client 广播 |
