# 联机状态同步策划案

> 文档编号：3_0  
> 日期：2026-03-01  
> 版本基准：v0.4.1  
> 前置文档：[5_v0.4.1_联机同步架构与代码分析报表](../版本报表/5_v0.4.1_联机同步架构与代码分析报表.md)

---

## 一、现状问题

当前联机模型是 **"位置可见"同步** —— 多人能看到彼此的位置，但地图、敌人、战斗、成长系统完全独立运行。实际体验是 **"各玩各的 + 能看到对方的影子"**。

### 1.1 现状一览

| 内容 | 当前状态 | 问题 |
|---|---|---|
| 地图 (`int[][] map`) | 各端独立随机生成 | 两个玩家看到的地牢完全不同，对方可能站在自己的墙里 |
| 敌人 (`enemies`) | 各端独立生成 + 独立 AI | 各自和自己的怪打，无法合作击杀 |
| 战斗判定 | 纯本地计算 | 无法对同一个怪造成伤害 |
| HP / 属性 / 等级 | 不传输 | 看不到队友血量、无法判断状态 |
| 楼梯 / 换层 | 各端独立触发 | 层数不同步，AB可能在不同层 |
| 死亡 / 重生 | 本地处理 | 对方死了也看不到 |
| 动画状态 | `action` 字段固定 `"idle"` | 看不到队友在攻击/受伤/移动 |
| 装备 / 道具 | 不同步 | 无法交易或看到队友装备 |

### 1.2 核心矛盾

**玩家对"联机"的期望是"合作探索同一个地牢"，而不是"各自探索随机地牢时能看见彼此的图标"。**

---

## 二、设计目标

分阶段解决"各玩各的"问题，优先级从高到低：

| 优先级 | 目标 | 玩家感知 |
|---|---|---|
| **P0** | 同一张地图 | "我们在同一个地牢里" |
| **P1** | 共享敌人 + 合作战斗 | "我们在打同一只怪" |
| **P2** | 动作状态可见 | "我能看到队友在跑/攻击/受伤" |
| **P3** | 属性/血量可见 | "我知道队友快死了" |
| **P4** | 楼梯/换层同步 | "我们一起进入下一层" |
| **P5** | 道具/装备交互 | "可以交易/分配战利品" |

---

## 三、Phase 1：同一张地图（P0）

### 3.1 方案：共享种子

**原理**：地图由 `Random(seed)` 生成，只要种子相同，所有端生成的 `int[][] map` 完全一致。

**改动**：
1. 房主在创建房间时生成一个随机种子 `long mapSeed`
2. `LanGameStartBroadcastPacket` 新增 `mapSeed` 字段
3. 客户端收到开始游戏信号后，用 `mapSeed` 初始化地图生成器
4. 房主自己也用同一个 `mapSeed`

**涉及文件**：
- `LanGameStartBroadcastPacket` → 加 `mapSeed` 字段
- `LanGameStartRequestPacket` → 加 `mapSeed` 字段（房主发起时携带）
- `LanMultiplayerService.broadcastGameStart()` → 生成种子并写入包
- `SimpleGameScreen` → 构造时接收 `mapSeed`，传给地图生成器
- 地图生成逻辑 → 接受外部传入的 `Random(seed)` 而非自建

**验证标准**：两个客户端看到完全相同的地图布局。

**工作量**：小。仅传一个 `long`，不新增同步通道。

### 3.2 额外：换层同步

地图种子解决的是"同一层地图相同"，但还需要解决换层时机：

**方案 A（简单）：房主触发全员换层**
- 只有房主能踩楼梯触发换层
- 换层时广播"换层信号 + 新层种子"
- 其他人无论在哪，强制跟随换层

**方案 B（投票）：楼梯交互需全员确认**
- 任何人踩楼梯发起投票
- 全员确认后才换层
- 体验好但交互复杂

**推荐先做 A**，快速验证核心体验。

---

## 四、Phase 2：共享敌人 + 合作战斗（P1）

### 4.1 核心难点

敌人状态（位置、HP、AI 决策）需要在所有客户端保持一致。这是从"各玩各的"到"真正联机"的最大跳跃。

### 4.2 方案：房主权威（Host Authority）

**原理**：只有房主运行敌人 AI 和战斗判定，其他客户端只负责渲染。

```
┌─────────────────────────────────────────────┐
│  房主进程                                    │
│  ├─ 运行本地玩家逻辑 (和现在一样)              │
│  ├─ 运行所有敌人 AI (独占)                    │
│  ├─ 执行所有战斗判定 (独占)                    │
│  └─ 周期性广播敌人状态快照                     │
└─────────────────────────────────────────────┘
          │ 敌人状态广播 (60Hz)
          ▼
┌──────────────────┐  ┌──────────────────┐
│  客户端B          │  │  客户端C          │
│  ├─ 本地玩家逻辑   │  │  ├─ 本地玩家逻辑   │
│  ├─ 接收敌人状态   │  │  ├─ 接收敌人状态   │
│  ├─ 插值渲染敌人   │  │  ├─ 插值渲染敌人   │
│  └─ 攻击 → 发请求  │  │  └─ 攻击 → 发请求  │
│     给房主判定     │  │     给房主判定     │
└──────────────────┘  └──────────────────┘
```

### 4.3 新增协议

| 命令 | 方向 | 说明 |
|---|---|---|
| `ENEMY_SYNC_BROADCAST` (新) | 房主 → 全体 | 周期性广播敌人状态（ID, x, y, hp, action） |
| `ATTACK_REQUEST` (新) | 客户端 → 房主 | "我要攻击ID=X的敌人" |
| `DAMAGE_RESULT` (新) | 房主 → 全体 | "ID=X的敌人受到N伤害，剩余HP=M" |
| `ENEMY_DEATH` (新) | 房主 → 全体 | "ID=X的敌人死亡" |
| `ENEMY_SPAWN` (新) | 房主 → 全体 | 新敌人生成（换层后/刷怪点） |

### 4.4 敌人状态快照

```java
class EnemyStateSnapshot {
    int enemyId;       // 敌人唯一标识（房主分配）
    int enemyType;     // 敌人类型（用于客户端选择正确贴图）
    float x, y;        // 格子坐标
    float visualX, visualY; // 像素坐标
    int hp, maxHp;     // 生命值
    String action;     // 动作状态（idle/walk/attack/hurt/die）
    long timestamp;
}
```

### 4.5 攻击判定流程

```
客户端B按下攻击键
  │
  ├─ 本地：播放攻击动画（即时反馈）
  │
  └─ 发送 ATTACK_REQUEST(targetId=5, attackerGuid=1, atk=12)
       │
       ▼ 房主收到
     房主判定：
       ├─ 验证 B 的位置是否在攻击范围内
       ├─ 计算伤害 = B.atk - enemy5.def
       ├─ enemy5.hp -= damage
       │
       └─ 广播 DAMAGE_RESULT(enemyId=5, damage=8, remainHp=42, attackerGuid=1)
            │
            ▼ 所有客户端收到
          ├─ 显示伤害数字
          ├─ 敌人受击动画
          └─ 更新本地敌人HP缓存
```

### 4.6 敌人 AI 与客户端关系

- 客户端 **不运行** 敌人 AI
- 客户端收到的敌人位置做 **插值渲染**（复用 NetworkTransform）
- 敌人对玩家的攻击也由房主判定，房主广播 `PLAYER_HURT(targetGuid, damage, remainHp)`

### 4.7 涉及改动

| 模块 | 改动 |
|---|---|
| `SimpleGameScreen` | 区分 HOST/CLIENT 模式：HOST 运行敌人 AI，CLIENT 仅渲染 |
| `EnemyAI` | 保持不变，仅在 HOST 端调用 |
| `LanMultiplayerService` | 新增敌人同步协议注册、敌人状态广播方法 |
| `GameRenderer` | 根据网络同步的敌人数据渲染，而非本地 AI 数据 |
| 新增 | `EnemyStateSnapshot`, `EnemySyncBroadcastPacket`, `AttackRequestPacket`, `DamageResultPacket` 等 |

**工作量**：中大。这是最关键的一步，完成后联机就有"合作打怪"的真实体验。

---

## 五、Phase 3：动作状态可见（P2）

### 5.1 目标

让队友能看到对方的实际动作：走路、攻击、受伤、死亡，而非永远 `idle`。

### 5.2 方案

将 `LanPlayerStateSnapshot.action` 字段接入动画状态机：

```java
// sendLocalState 时传入真实动作
String action = player.isAttacking() ? "attack"
              : player.isMoving()    ? "walk"
              : player.isHurt()      ? "hurt"
              : "idle";
lanService.sendLocalState(player.x, player.y, player.visualX, player.visualY, action);
```

客户端收到远程玩家状态后，根据 `action` 字段切换对方的动画。

**工作量**：小。`action` 字段和传输通道已经存在，只需接入。

---

## 六、Phase 4：属性/血量可见（P3）

### 6.1 目标

在队友头顶显示血条，知道队友当前状态。

### 6.2 方案

在 `LanPlayerStateSnapshot` 中扩展字段：

```java
int hp;       // 当前生命
int maxHp;    // 最大生命
int level;    // 等级
```

客户端渲染远程玩家时读取这些字段画血条。

**注意**：属性计算仍然各端独立，这里只是"展示"用途。如果 Phase 2 做了房主权威战斗判定，那么 HP 应以房主广播的为准。

**工作量**：小。扩展已有 Snapshot + 渲染层加血条。

---

## 七、Phase 5：楼梯/换层同步（P4）

在 Phase 1 方案 A 的基础上补充细节：

### 7.1 协议

| 命令 | 方向 | 说明 |
|---|---|---|
| `FLOOR_CHANGE_BROADCAST` (新) | 房主 → 全体 | 携带新层种子 + 层数 |

### 7.2 流程

```
房主踩到楼梯
  │
  ├─ 生成新层种子 newSeed
  ├─ 广播 FLOOR_CHANGE(floor=2, seed=newSeed)
  └─ 本地用 newSeed 生成第2层地图
       │
       ▼ 所有客户端收到
     ├─ 用 newSeed 生成第2层地图
     ├─ 清空本地敌人缓存（等待房主广播新敌人）
     └─ 将玩家传送到楼梯出口位置
```

### 7.3 后续优化

- 加入"等待队友"机制：房主踩楼梯后倒计时，给其他人赶到楼梯口的时间
- 或允许分层探索（复杂度高，暂不考虑）

**工作量**：小-中。依赖 Phase 1 + Phase 2。

---

## 八、Phase 6：道具/装备交互（P5）

最低优先级，留作未来扩展：

- 掉落物同步：房主生成掉落物，广播给客户端
- 拾取请求：客户端发请求，房主判定（先到先得）
- 装备展示：在 Snapshot 中加入装备外观 ID
- 交易系统：双方确认的交易协议

**工作量**：大。涉及道具系统、UI 交互，在核心战斗同步稳定后再做。

---

## 九、实施路线总览

```
Phase 1: 同一张地图                    ← 工作量: 小
  ├─ 共享地图种子
  └─ 房主触发换层
         │
Phase 2: 共享敌人 + 合作战斗            ← 工作量: 中大 ⭐关键里程碑
  ├─ 房主权威敌人 AI
  ├─ 攻击请求 → 房主判定 → 结果广播
  └─ 敌人状态插值渲染
         │
Phase 3: 动作状态可见                   ← 工作量: 小
  └─ action 字段接入动画状态机
         │
Phase 4: 属性/血量可见                  ← 工作量: 小
  └─ Snapshot 扩展 + 血条渲染
         │
Phase 5: 楼梯/换层同步                  ← 工作量: 小-中
  └─ 换层广播 + 新层种子
         │
Phase 6: 道具/装备交互                  ← 工作量: 大
  └─ 掉落物/拾取/交易
```

### 里程碑定义

| 里程碑 | 包含 Phase | 玩家体验 |
|---|---|---|
| **M1 "同一个世界"** | Phase 1 | 两人在同一张地图里走动 |
| **M2 "合作冒险"** | Phase 1-3 | 能一起打怪，看到彼此动作 |
| **M3 "完整联机"** | Phase 1-5 | 一起探索、换层、看到队友血量 |
| **M4 "社交联机"** | Phase 1-6 | 完整的合作 + 道具交互 |

---

## 十、风险与注意事项

| 风险 | 影响 | 缓解措施 |
|---|---|---|
| Phase 2 房主掉线 | 所有敌人停止更新 | 迁移房主权限（复杂），或提示重连 |
| 敌人广播包过大 (50怪×60Hz) | 服务器带宽/CPU 压力 | 仅广播视野内的敌人 / 降低频率到 30Hz |
| 攻击判定延迟 (WAN) | 玩家攻击后 200ms 才看到伤害 | 客户端本地先预演动画 + 伤害数字延迟显示 |
| 地图种子 ≠ 地图完全一致 | 如果生成逻辑有平台差异/浮点差异 | 确保生成逻辑用整数运算 + 固定算法 |
| 客户端作弊 | 发送虚假攻击力 | Phase 2 中房主应读取自己维护的玩家属性，不信任客户端传来的 atk |
