# Magic Dungeon 核心策划案

---

## 一、核心玩法定位

- **游戏类型**：魔塔式即时走格子 Roguelike 地牢冒险
- **移动机制**：格子化坐标（Grid-based），每次移动/攻击触发独立冷却（CD）
- **操作策略**：即时制，允许利用移速CD差进行走位拉扯、规避攻击
- **多人兼容**：走格子天然适配多人同步（仅需同步格子坐标+动作状态），预留兼容性

---

## 二、属性系统

### 2.1 六大核心属性

| 属性 | 缩写 | 1属性点对应值 | 初始值（1级） | 说明 |
|------|------|-------------|-------------|------|
| 生命 | HP | 20 | 20 | 容错上限 |
| 魔法 | MP | 10 | 10 | 技能与破防资源 |
| 攻击 | ATK | 1 | 1 | 物理输出基数 |
| 防御 | DEF | 1 | 1 | 物理/魔法防御基数 |
| 攻速 | ASP | — | 100% | 仅靠道具/装备提升 |
| 移速 | MOV | — | 100% | 仅靠道具/装备提升 |

### 2.2 隐性属性

- **魔法防御（MDEF）**= DEF / 2（向下取整）

### 2.3 ASP / MOV 特殊规则

- **不可**通过升级自动成长，**不可**通过加点获得
- 仅可通过限定道具增加（类似泰拉瑞亚）
- **上限**：初始值的 300%
- 特殊装备可在此上限基础上额外增加（百分比增强/固定点数增强）

### 2.4 属性计算流水线

计算优先级严格按以下顺序：

```
最终值 = (基础值 + 等级固定点 + 自由加点 + 装备固定加成) × (1 + 百分比增益总和)
```

- 百分比增益/减益在基础属性之后计算
- ASP/MOV 的 300% 上限作用于最终值

---

## 三、等级与经验体系

### 3.1 经验值累积制

- **不设**每级独立经验槽，仅记录**总经验值**
- 玩家可看到从0级至今获得的所有经验
- 等级由总经验值实时推导

### 3.2 升级所需经验公式

$$XP_{需要}(L) = \lfloor 100 \times 1.2^{(L-1)} \rfloor$$

- 1→2级：100 XP
- 10→11级：约 516 XP
- 20→21级：约 3200 XP

### 3.3 每级成长规则

- **基础值**：等同于0级自带的 4 点固定加点（HP:20, MP:10, ATK:1, DEF:1）
- **每升1级**：
  - **固定加点**：HP/MP/ATK/DEF 四项各 +1 属性点对应值（即 HP+20, MP+10, ATK+1, DEF+1）
  - **自由点数**：获得 **4 点**自由属性点，可手动分配至 HP/MP/ATK/DEF

> 示例：0级 = 4固定点；1级 = 8固定 + 4自由；2级 = 12固定 + 8自由

### 3.4 任意等级状态快照

不考虑装备时，L 级角色的属性点数：

- **总固定点** = (L + 1) × 4（含基础值的 4 点）
- **总自由点** = L × 4
- **总属性点** = 8L + 4

各属性基础值（不含装备）：
- HP_base = (L + 1) × 20 + 分配到HP的自由点 × 20
- MP_base = (L + 1) × 10 + 分配到MP的自由点 × 10
- ATK_base = (L + 1) × 1 + 分配到ATK的自由点 × 1
- DEF_base = (L + 1) × 1 + 分配到DEF的自由点 × 1

> 此算法下，任意等级的总点数一目了然，便于经验掉落后的等级回落与属性重算。

---

## 四、战斗系统

### 4.1 伤害公式（无保底）

参考魔塔，防御高于攻击即可完全无伤，无论玩家或怪物。

- **物理伤害**：$Damage_{物理} = \max(0,\ ATK_{攻方} - DEF_{守方})$
- **魔法伤害**：$Damage_{魔法} = \max(0,\ ATK_{魔法} - MDEF_{守方})$

> 由于 MDEF = DEF/2，魔法更容易破防，因此魔法攻击应作为稀缺资源或受 MP 严格限制。

### 4.2 冷却系统

- 移动CD 与 攻击CD **相互独立**
- 移动CD 由 MOV 决定：$CD_{移动} = 基础值 / (1 + MOV增益)$
- 攻击CD 由 ASP 决定：$CD_{攻击} = 基础值 / (1 + ASP增益)$
- 移动和攻击可同时进行（"边走边砍"）

### 4.3 魔法来源

- **方案A — 主动技能**：任何武器下均可消耗 MP 释放魔法（火球、雷击等），高爆发破防
- **方案C — 法杖武器**：装备法杖后普攻转为魔法伤害，但攻速（ASP）大幅降低

### 4.4 攻击范围

| 武器类型 | 范围 | 穿透 | 说明 |
|---------|------|------|------|
| 普通近战 | 4方向邻接1格 | 无穿透 | 基础武器，侧重攻速和爆发 |
| 长柄武器 | 4方向直线2格 | 全穿透 | 走廊战利器，同时打击两个目标 |
| 远程能量弹 | 4方向直线5格 | 无穿透 | 单点爆破，遇第一个实体/墙壁停止 |
| 远程箭矢 | 4方向直线5格 | 全穿透 | 极强，可清理整条走廊 |

- 穿透只有两种：**不穿透** 或 **射程内全穿透**
- 穿透仅被**实体墙壁**阻挡

### 4.5 穿透衰减

每多穿透一个目标，伤害衰减 30%：

$$D_n = D_{基础} \times 0.7^{(n-1)}$$

| 第n个目标 | 伤害倍率 |
|-----------|---------|
| 第1个 | 100% |
| 第2个 | 70% |
| 第3个 | 49% |
| 第4个 | ≈34% |

### 4.6 特殊攻击形状（远期）

- 圆形、十字型等特殊范围暂不实现，仅记录备忘
- 可能作为特殊技能范围，需有指示器图形提示

---

## 五、死亡与持久化

### 5.1 世界持久化

- 地图状态**永久保留**：
  - 已杀死的固定怪物不复活
  - 已开启的宝箱、已拾取的物品不刷新
  - 游戏本质是"**资源总量有限的博弈**"
- 塔记录**已通过最高层级**

### 5.2 死亡惩罚

- **位置回溯**：角色回到**营地**
- **经验掉落**：扣除当前总经验的 **20%**，等级回落至对应等级
  - **固定点**：因降级失去的固定点**全部扣除**
  - **自由点**：因降级失去的自由点**平均扣除**（各属性均匀扣减）
- **金币掉落**：掉落当前持有金币的 **50%**
  - 掉落金币留在死亡点，其中 **60% 永久损失**
  - 仅可拾回掉落金币的 **40%**（即总金币的 20%）
- **装备掉落**：随机掉落 **2~5 件**背包内装备，**直接消失**不可找回

---

## 六、世界结构与地图系统

### 6.1 世界区域

沿用旧项目世界区域概念：

- **营地（Camp）**：出生点 / 死亡复活点，独立的 1 层世界区域（暂定，未来可能扩展）
- **传送门**：在营地中通过传送门打开**世界区域羊皮卷**，选择目标区域进入
- **当前区域**：
  - **岩石地牢**（新手地牢）
  - **迷雾湿地**
  - **灼热漠地**
  - **深渊古堡**

### 6.2 地图规格

- 庞大单层地图，内存常驻，不分片加载
- 渲染采用**相机裁剪 + 安全阈值**，仅绘制视野内格子

### 6.3 精灵指引（Fairy Guidance）

#### 未通关层 — 模糊象限指引

- 精灵告知下层入口所在的 **90° 扇形象限方向**（东北/西北/东南/西南）
- **仅知大方向**，不知准确角度，玩家仍需在复杂地形中寻路
- **有冷却**（可设为步数冷却或时间冷却），不可无限使用
- 视觉表现：精灵发出半透明扇形光晕（90°），缓慢闪烁指向象限

#### 已通关最高层 — 精确阶梯指引

- 上层与下层阶梯**均可精确指引**，**无冷却**可持续使用
- 视觉表现：精灵牵引丝线状流光，沿格子路径铺设
  - 蓝色流光 → 指引上楼（回城感）
  - 金色流光 → 指引下楼（进取感）
- 玩家可点击精灵**切换指引目标**（上楼/下楼）

---

## 七、动态资源 — 巢穴系统

解决魔塔类游戏"资源枯竭"的核心方案。

- **生成方式**：**地图生成时**低概率生成普通/精英怪物的巢穴
- **运行规则**：
  - 巢穴缓慢产出同类怪物（有冷却间隔）
  - 每个巢穴有**存活数量上限**，防止无限堆积
- **唯一怪物**（BOSS/特殊怪）**不存在巢穴**
- **战术抉择**：
  - 保留巢穴 → 当做经验"提款机"，定期回来收割
  - 摧毁巢穴 → 清除推图障碍或防止被骚扰

---

## 八、掉落机制

| 类别 | 来源 | 规则 |
|------|------|------|
| 经验 (XP) | 击杀怪物 | 根据怪物等级由经验曲线公式直接计算 |
| 金币 (Gold) | 怪物/宝箱 | 怪物：等级 × 随机系数；死亡掉落 50%（仅可拾回 40%） |
| 装备/物品 | 宝箱/精英怪 | 固定掉落（地图不重置，拿走即消失） |
| 消耗品（药水） | 普通怪物 | 概率掉落，作为推图续航资源 |

---

## 九、怪物属性设计

### 9.1 怪物成长规则

与玩家类似：
- **固定加点**：4 点，全属性 +1（HP+20, MP+10, ATK+1, DEF+1）
- **自由加点**：4 点，按怪物类型分配

### 9.2 怪物类型模板

| 类型 | 自由点分配 | 战术角色 |
|------|-----------|---------|
| 均衡怪 | 平均分配 | 基础挑战 |
| 坦克怪 | 全加 DEF | 逼迫玩家消耗 MP 破防 |
| 刺客怪 | 全加 ATK | 考验玩家 HP 容错 |

---

## 十、开发验证路径

- **第一步**：完成基础数据模型定义
- **第二步**：完成所有 API 的单元测试
- **平衡目标（后续）**：玩家在连续战斗后处于"**重伤但不死**"的极限状态（约 15%~25% 血量）

---

## 十一、待确认事项

- [ ] 巢穴耐久机制（普通攻击可摧毁 / 需要特定道具）
- [ ] 精灵指引的具体冷却数值（步数冷却 or 时间冷却，具体值）
- [ ] 精确指引丝线路径的画面表现细节
- [ ] 特殊攻击形状的技能指示器设计




