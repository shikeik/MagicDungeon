# Magic Dungeon 2 — 核心系统设计案

> 本文档以当前 **已实现代码** 为唯一权威；尚未落地的设计以「📝 计划中」标注。
> 最后同步版本: **0.2.0** | 同步日期: 2026-02-21

---

## 1. 核心玩法概述

- **游戏类型**: 走格子 (Grid-based) 即时制 Roguelike 冒险
- **移动与攻击**: 所有操作发生在网格上，移动/攻击拥有独立冷却 (CD)
- **核心策略**: 利用高移速产生的 CD 差进行走位拉扯 (Kiting)
- **地图**: 庞大单层地图，内存常驻，状态永久保留

---

## 2. 属性系统 ✅

> 源码: `StatType.java` · `StatData.java` · `StatCalculator.java`

### 2.1 六大基础属性

| 属性 | 缩写 | `valuePerPoint` | 初始值 (0级) | 可加点 | 说明 |
|------|------|:---------------:|:------------|:------:|------|
| 生命 | HP | 20f | 20 | ✅ | 容错上限 |
| 魔法 | MP | 10f | 10 | ✅ | 技能与破防资源 |
| 攻击 | ATK | 1f | 1 | ✅ | 物理伤害基数 |
| 防御 | DEF | 1f | 1 | ✅ | 物理/魔法防御基数 |
| 攻速 | ASP | 0f | 100% (1.0) | ❌ | 仅装备/道具提升 |
| 移速 | MOV | 0f | 100% (1.0) | ❌ | 仅装备/道具提升 |

- `StatType.ALLOCATABLE = {HP, MP, ATK, DEF}` — 可通过自由点分配的属性
- `isAllocatable()` — HP/MP/ATK/DEF 返回 true，ASP/MOV 返回 false

### 2.2 隐性属性

- **魔法防御 (MDEF)**: `getDEF() / 2f`
  - 采用 **浮点除法**，不做向下取整
  - 调用方在发起魔法攻击判定时自行传入 MDEF

### 2.3 属性计算流水线

#### HP / MP / ATK / DEF（可加点属性）

$$
\text{最终值} = \bigl((\text{fixedPts} + \text{freePts}) \times \text{valuePerPoint} + \text{equipFixed}\bigr) \times (1 + \text{percentBonus})
$$

| 变量 | 来源 | 说明 |
|------|------|------|
| `fixedPts` | `level + 1` | 含 0 级基础 1 点 |
| `freePts` | 玩家分配 | 自由属性点数 |
| `equipFixed` | 装备 | 固定数值加成 |
| `percentBonus` | 药水/被动 | 百分比增益（0.1 = +10%） |

#### ASP / MOV（速度属性）

$$
\text{capped} = \min\bigl((1.0 + \text{equipFixed}) \times (1 + \text{percentBonus}),\; \text{SPEED\_CAP}\bigr)
$$
$$
\text{最终值} = \text{capped} + \text{uncappedBonus}
$$

| 常量 / 变量 | 值 | 说明 |
|-------------|:--:|------|
| 基础值 | 1.0f | 即 100% |
| `SPEED_CAP` | 3.0f | 即 300%，常规上限 |
| `uncappedBonus` | 装备额外加成 | 特殊装备可突破 cap |

### 2.4 点数公式

| 公式 | 表达式 | 说明 |
|------|--------|------|
| 每属性固定点 | `level + 1` | 含 0 级基础 1 点 |
| 总固定点 | `(level + 1) × 4` | 4 项属性 |
| 总自由点 | `level × 4` | 每升 1 级获得 4 自由点 |
| 总属性点 | `8 × level + 4` | 固定 + 自由 |

**示例**:
| 等级 | 固定点 | 自由点 | 总点数 |
|:----:|:------:|:------:|:------:|
| 0 | 4 | 0 | 4 |
| 1 | 8 | 4 | 12 |
| 10 | 44 | 40 | 84 |

### 2.5 冷却计算

$$
CD_{\text{攻击}} = \frac{\text{baseCd}}{\text{aspMultiplier}} \quad (\text{aspMultiplier} > 0)
$$
$$
CD_{\text{移动}} = \frac{\text{baseCd}}{\text{movMultiplier}} \quad (\text{movMultiplier} > 0)
$$

- 当乘数 ≤ 0 时返回 `baseCd`（无加速）

### 2.6 自由点分配规则

- `addFreePoints(StatType, int)` 返回 **boolean**
- 校验规则:
  1. 属性必须为可加点类型（`isAllocatable()`）
  2. 分配点数必须 > 0
  3. 分配不能超过剩余自由点（`getRemainingFreePoints()`）
- `validate()` — 检查已分配总点数不超限（`remaining >= 0`）

---

## 3. 战斗系统 ✅

> 源码: `CombatEngine.java`

### 3.1 伤害公式（无保底）

$$
\text{物理伤害} = \max(0,\; \text{ATK}_{\text{攻}} - \text{DEF}_{\text{守}})
$$
$$
\text{魔法伤害} = \max(0,\; \text{魔法ATK} - \text{MDEF}_{\text{守}})
$$

- **无最低保底**: 防御 ≥ 攻击时伤害为 0
- `calcMagicDamage(magAtk, mdef)` — 调用方需自行计算并传入 MDEF

### 3.2 穿透衰减

$$
D_n = D_{\text{base}} \times 0.7^{\,n} \quad (n = \text{targetIndex},\; n \geq 1)
$$

| 常量 | 值 | 说明 |
|------|:--:|------|
| `PIERCE_DECAY` | 0.7f | 每多穿透一个目标保留 70% |
| `MIN_DAMAGE_THRESHOLD` | 0.1f | 低于此值的衰减伤害归零 |

| 目标序号 (targetIndex) | 伤害倍率 | 备注 |
|:----------------------:|:--------:|------|
| 0（第 1 个） | 100% | 无衰减，不受阈值影响 |
| 1（第 2 个） | 70% | |
| 2（第 3 个） | 49% | |
| 3（第 4 个） | ≈34.3% | |
| 19（第 20 个） | ≈0.114% | 阈值边界，仍保留 |
| 20（第 21 个） | ≈0.080% | < 0.1 → **归零** |

### 3.3 武器类型与攻击范围

| 武器类型 | 枚举 | 范围 (格) | 穿透 |
|---------|------|:---------:|:----:|
| 近战 | `MELEE` | 4方向 1 | 无 |
| 长柄 | `SPEAR` | 4方向 2 | 全穿透 |
| 能量弹 | `MAGIC_BOLT` | 4方向 5 | 无 |
| 箭矢 | `ARROW` | 4方向 5 | 全穿透 |

### 3.4 魔法伤害来源 📝 计划中

1. **主动技能**: 消耗 MP，高爆发破防
2. **法杖武器**: 普攻转魔法伤害，大幅降低 ASP

---

## 4. 经验与成长系统 ✅

> 源码: `GrowthCalculator.java`

### 4.1 经验值机制

- **累积制**: 仅记录 **总经验值**，不设每级独立经验槽
- **等级实时推导**: `level = f(totalXp)`，等级不独立存储

### 4.2 升级所需经验

$$
\text{xpForNextLevel}(L) = \lfloor 100 \times 1.2^{(L-1)} \rfloor
$$

| 常量 | 值 |
|------|:--:|
| `XP_BASE` | 100 |
| `XP_GROWTH_RATE` | 1.2 |

- 返回类型: **`long`**（防止高等级溢出）
- 溢出保护: 当 `double` 结果 ≥ `Long.MAX_VALUE` 时返回 `Long.MAX_VALUE`

| 等级跃迁 | 所需 XP | 备注 |
|:--------:|--------:|------|
| 0 → 1 | 83 | `floor(100 × 1.2⁻¹)` |
| 1 → 2 | 100 | `floor(100 × 1.2⁰)` |
| 9 → 10 | 429 | `floor(100 × 1.2⁸)` |
| ~95 级 | ~21 亿 | 接近 int 上限 |
| ~216 级 | ~9.2×10¹⁸ | 接近 long 上限，触发溢出保护 |

### 4.3 总经验与等级推导

| 方法 | 说明 | 溢出保护 |
|------|------|:--------:|
| `totalXpForLevel(targetLevel)` | 逐级累加所需经验 | 累加超 long 范围时返回 `Long.MAX_VALUE` |
| `levelFromXp(totalXp)` | 从总经验反推等级 | 安全比较防止下溢 |
| `xpProgress(totalXp)` | 返回 `[当前级已有, 升级需要]` | 溢出时返回 `Long.MAX_VALUE` |

### 4.4 每级成长规则

每升 1 级:
1. **固定成长**: HP/MP/ATK/DEF 各自动 +1 属性点（即 +20HP, +10MP, +1ATK, +1DEF）
2. **自由点数**: 获得 **4 点** 自由属性点，可分配至 HP/MP/ATK/DEF

---

## 5. 死亡惩罚系统 ✅

> 源码: `DeathPenalty.java`

### 5.1 惩罚常量

| 常量 | 值 | 说明 |
|------|:--:|------|
| `XP_LOSS_RATE` | 0.20 (20%) | 经验扣除比例 |
| `GOLD_DROP_RATE` | 0.50 (50%) | 金币掉落比例 |
| `GOLD_PERMANENT_LOSS` | 0.60 (60%) | 掉落金币中永久损失 |
| `EQUIP_DROP_MIN` | 2 | 装备掉落最少件数 |
| `EQUIP_DROP_MAX` | 5 | 装备掉落最多件数 |

### 5.2 经验惩罚

$$
\text{xpLost} = \lfloor \text{totalXp} \times 0.20 \rfloor
$$

- 扣除后等级由 `GrowthCalculator.levelFromXp(xpAfter)` 重新推导
- 可能发生 **降级 (Level Down)**

### 5.3 金币惩罚

$$
\text{goldDropped} = \lfloor \text{currentGold} \times 0.50 \rfloor
$$
$$
\text{goldPermanentLost} = \lfloor \text{goldDropped} \times 0.60 \rfloor
$$
$$
\text{goldRecoverable} = \text{goldDropped} - \text{goldPermanentLost}
$$

- 掉落金币留在死亡点，仅可拾回 40%（即总金币的 ~20%）

### 5.4 装备掉落 📝 由上层实现

- 随机掉落 2~5 件背包内装备，**直接消失** 不可找回

### 5.5 降级后自由点扣除 — 循环均匀分配算法

```
lostFreePoints = (levelBefore × 4) - (levelAfter × 4)
```

**循环扣除流程**:
1. 每轮统计仍有自由点余额的属性数量（`activeCount`）
2. 计算每属性应扣点数: `perStat = max(1, remaining / activeCount)`
3. 对每个 ALLOCATABLE 属性: 实际扣除 `min(perStat, min(currentPts, remaining))`
4. 重复直到扣完或所有属性归零

- 固定点数随等级自动重算（委托 `StatCalculator`），无需手动扣除
- 位置回溯由上层实现

---

## 6. 世界与探索 📝 计划中

### 6.1 世界持久化

- 地图状态永久保留: 已杀怪物/已开宝箱/已拾物品不重置
- 记录已通过最高层级
- 死亡后角色回营地

### 6.2 巢穴系统 (Nest System)

- 击杀怪物后有概率在原地生成巢穴
- 巢穴产出同类怪物（有冷却，有存活上限）
- 唯一怪/BOSS 不可再生
- 战术: 保留巢穴当"经验提款机" vs 摧毁以清除障碍

### 6.3 精灵指引 (Fairy Guidance)

- **未通关层**: 90° 扇形光晕模糊指引，有冷却
- **已通关最高层**: 丝线流光精确路径，无冷却，可切换目标

---

## 7. 技术架构

### 7.1 已实现模块

| 模块 | 源文件 | 状态 |
|------|--------|:----:|
| 属性系统 | `StatType` · `StatData` · `StatCalculator` | ✅ |
| 战斗引擎 | `CombatEngine` | ✅ |
| 成长计算 | `GrowthCalculator` | ✅ |
| 死亡惩罚 | `DeathPenalty` | ✅ |

### 7.2 计划模块

| 模块 | 职责 |
|------|------|
| CooldownModule | ASP/MOV 计时器 |
| MapModule | 网格地图 / 持久化 |
| EntityModule | Player / Monster / Nest |
| GuidanceModule | 精灵指引寻路 |
| InputModule | 操作映射 |
| SaveModule | 存档序列化 |

### 7.3 包路径

```
com.goldsprite.magicdungeon2.core
├── stats/
│   ├── StatType.java
│   ├── StatData.java
│   └── StatCalculator.java
├── combat/
│   └── CombatEngine.java
└── growth/
    ├── GrowthCalculator.java
    └── DeathPenalty.java
```

### 7.4 测试覆盖（72 个测试）

| 测试类 | 数量 | 覆盖范围 |
|--------|:----:|---------|
| `StatDataTest` | 24 | 点数公式 / 属性 / MDEF / 装备 / 百分比 / ASP·MOV 上限 / 冷却 / 溢出 / 校验 / 全管线 |
| `CombatEngineTest` | 17 | 物理 / 魔法 / 穿透 / 武器枚举 / 深层归零 / 阈值边界 / 首目标豁免 |
| `GrowthCalculatorTest` | 17 | XP 公式 / 等级推导 / 进度条 / 300 级压力 / 溢出保护 |
| `DeathPenaltyTest` | 13 | XP 损失 / 降级 / 金币 / 均匀扣除 / 循环扣减 / 非整除 |
| **合计** | **72** | — |

---

*以实际代码为准同步 · v0.2.0 · 2026-02-21*
