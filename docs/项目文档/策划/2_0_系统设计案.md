# Magic Dungeon 核心系统设计案 (Core System Design)

> 基于 1_0_ai讨论.md 的核心策划与架构重构方案。

## 1. 核心玩法概述 (Core Gameplay)

*   **游戏类型**: 走格子 (Grid-based) 即时制 Roguelike 冒险。
*   **核心机制**:
    *   **移动与攻击**: 所有的移动和战斗都发生在网格上。
    *   **独立冷却 (CD)**: 移动和攻击拥有相互独立的冷却时间。即时制允许玩家利用高移速产生的 CD 差进行走位拉扯（Kiting），规避攻击。
    *   **地图**: 采用庞大的单层地图，内存常驻，不分片加载，状态永久保留。

## 2. 属性系统 (Attribute System)

### 2.1 六大基础属性 (The 6 Pillars)

所有属性的最终值计算遵循：
$$
\text{最终值} = (\text{初始} + \text{等级固定点} + \text{自由加点} + \text{装备固定值}) \times (1 + \text{百分比增益})
$$

| 属性名称 | 缩写 | 1点对应数值 | 初始值 (1级) | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **生命** | **HP** (Health Points) | 20 | 20 | 生存容错上限。 |
| **魔法** | **MP** (Magic Points) | 10 | 10 | 技能释放与破防资源。 |
| **攻击** | **ATK** (Attack) | 1 | 1 | 物理伤害基础。 |
| **防御** | **DEF** (Defense) | 1 | 1 | 物理/魔法防御基础。 |
| **攻速** | **ASP** (Attack Speed) | - | 100% | 动作频率。仅靠道具/装备提升，上限 300%。 |
| **移速** | **MOV** (Movement) | - | 100% | 跑图效率。仅靠道具/装备提升，上限 300%。 |

### 2.2 隐性属性

*   **魔法防御 (MDEF)**: 固定等于 $ \lfloor \text{DEF} / 2 \rfloor $ (向下取整)。

## 3. 战斗系统 (Combat System)

### 3.1 伤害公式

*   **物理伤害**:
    $$ \text{Damage}_{phys} = \max(0, \text{ATK}_{phys} - \text{DEF}_{target}) $$
*   **魔法伤害**:
    $$ \text{Damage}_{mag} = \max(0, \text{ATK}_{mag} - \text{MDEF}_{target}) $$
    *   *魔法伤害来源*:
        1.  **主动技能**: 消耗 MP 释放，高爆发破防。
        2.  **法杖武器**: 普通攻击直接转为魔法伤害，但大幅降低攻击频率 (ASP)。

### 3.2 攻击范围与穿透

| 武器类型 | 范围 | 特性 |
| :--- | :--- | :--- |
| **近战** | 4方向 1格 | 无穿透。 |
| **长柄** | 4方向直线 2格 | **全穿透**。 |
| **远程(能量)** | 4方向直线 5格 | **不穿透**，单点爆发。 |
| **远程(箭矢)** | 4方向直线 5格 | **全穿透**，群体打击。 |

*   **穿透衰减机制**:
    每多穿透一个目标，伤害衰减 30%。
    $$ D_n = D_{base} \times 0.7^{(n-1)} $$

## 4. 经济与成长系统 (Economy & Progression)

### 4.1 经验值 (XP) 与等级

*   **累积制**: 不设每级独立的经验槽，仅记录**总经验值**。
*   **等级算法**: 等级由总经验值实时推导。
*   **升级所需经验**: 采用指数增长模型 (约 1.2 倍率)。
*   **成长规则 (每级)**:
    1.  **固定成长**: 4项基础属性 (HP/MP/ATK/DEF) 自动各增加 **1点** 对应数值 (即 +20HP, +10MP, +1ATK, +1DEF)。
    2.  **自由点数**: 获得 **4点** 自由属性点，可由玩家自由分配。

### 4.2 死亡与惩罚 (Death Penalty)

*   **世界持久化**: 地图状态永久保留。已杀死的怪物 (非巢穴产出)、已开启的宝箱、已拾取的物品**不会重置**。
*   **最高层记录**: 系统记录已通过的最高层级。
*   **死亡惩罚**:
    1.  **经验掉落**: 扣除当前**总经验值的 20%**。若扣除后低于当前等级门槛，将发生**降级 (Level Down)**。
    2.  **金钱损失**: 扣除当前持有金币的 20%。
    3.  **位置回溯**: 角色强制回到当前层起点或营地。

### 4.3 掉落机制 (Loot)

*   **怪物掉落**: 怪物死亡掉落自身携带经验的 10% (归玩家)。
*   **物品**:
    *   普通怪: 小概率掉落消耗品 (药水)。
    *   精英/宝箱/Boss: 固定掉落装备/关键物品。

## 5. 世界与探索 (World & Exploration)

### 5.1 动态生态: 巢穴系统 (Nest System)

为了解决永久死亡导致的资源枯竭问题，引入动态刷新机制。

*   **生成**: 击杀普通/精英怪物后，有概率在原地生成**巢穴**。
*   **功能**: 缓慢产出同类怪物 (有生成冷却)。
*   **限制**: 每个巢穴有**存活数量上限**，防止怪物无限堆积。
*   **策略**: 玩家可选择保留巢穴作为"经验提款机"，或摧毁巢穴以消除推图障碍。*唯一怪/Boss不可再生。*

### 5.2 精灵指引系统 (Fairy Guidance)

解决庞大地图的迷路问题，同时保持探索感。

1.  **模糊指引 (未通关层)**:
    *   **表现**: 精灵显示 **90° 扇形**光晕，指向下层入口的大致象限。
    *   **限制**: 消耗能量 (有步数/时间冷却)，作为保底手段。
2.  **精确指引 (已通关最高层)**:
    *   **表现**: 精灵牵引出**丝线流光**，直接沿格子路径铺设。
    *   **功能**: **无冷却**，玩家可切换指引目标 (上楼/下楼/回城)。

## 6. 技术架构模块划分 (Architecture)

基于高内聚低耦合原则，将代码划分为三大核心层。

### 6.1 核心逻辑层 (Core Logic)
*不依赖图形库，纯 Java 实现，负责数学运算与规则。*

*   **StatsModule (属性模块)**:
    *   六大属性流水线计算 (Base -> Fixed -> Percent -> Limit)。
    *   自由点数分配、等级推导算法。
*   **CombatModule (战斗模块)**:
    *   物理/魔法双重伤害判定。
    *   穿透衰减算法 ($ 0.7^{n-1} $) 实现。
*   **GrowthModule (成长模块)**:
    *   经验值累积、死亡降级逻辑。
*   **CooldownModule (冷却模块)**:
    *   管理 ASP/MOV 计时器，确保逻辑帧的确定性。

### 6.2 世界与数据层 (World & Data)
*负责游戏状态管理与持久化。*

*   **MapModule (地图模块)**:
    *   网格数据结构、地形阻挡。
    *   持久化记录 (怪物存活、宝箱状态、巢穴位置)。
*   **EntityModule (实体模块)**:
    *   定义 Player, Monster, Nest 数据结构。
    *   巢穴生成与刷怪逻辑。
*   **SaveModule (存档模块)**:
    *   序列化系统，存储世界状态快照。

### 6.3 交互与系统层 (Systems)
*连接逻辑与表现。*

*   **GuidanceModule (指引模块)**:
    *   象限计算算法 (模糊指引)。
    *   A* 或 BFS 寻路算法 (精确指引)。
*   **InputMapping (输入映射)**:
    *   将操作转化为逻辑指令 (Move, Attack, Cast)。
*   **Simulator (模拟模块)**:
    *   (开发工具) 纯数值跑测，验证加点与生存曲线平衡。

---
*Created by Github Copilot based on 1_0_ai讨论.md*
