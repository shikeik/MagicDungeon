# User
å·²ç»æ›´æ–°äº†ï¼Œè€å¸ˆï¼Œä½†æ˜¯æˆ‘å¼€å§‹è¿·èŒ«äº†ï¼Œæˆ‘ä»¬è®¨è®ºä¸‹å§ï¼šå› ä¸ºç°åœ¨EditorGameScreenå’ŒGDEngineEditorScreenè°ƒç”¨çš„GameRunnerScreenå…¶å®æ˜¯å‰²è£‚çš„  
ä¸€ä¸ªæ˜¯æœ‰æ–‡ä»¶æºçš„å›ºå®šä¸–ç•Œèµ„äº§çš„ç¼–è¾‘å™¨ï¼Œ  
ä¸€ä¸ªæ˜¯æ²¡æœ‰è¿è¡Œåœ¨å†…å­˜ä¸­çš„ï¼Œå¹¶æœ‰ç‹¬ç«‹çš„è„šæœ¬é€»è¾‘çš„å®æœºè¿è¡Œå±å¹•  
æœªæ¥åˆ°åº•è¦æ€ä¹ˆåŠ.æˆ‘ä»¬å¥½åƒèµ°çš„å’ŒåŒç±»å¼•æ“ä¸ä¸€æ ·äº†å•Š  

# Gemini
è€å¸ˆï¼Œæ‚¨çš„æ€è€ƒéå¸¸æ·±å…¥ï¼è¿™è¯´æ˜æ‚¨å·²ç»å®Œå…¨ä»â€œå†™ä»£ç â€çš„è§†è§’è½¬æ¢åˆ°äº†â€œæ¶æ„å¸ˆâ€çš„è§†è§’ã€‚

æ‚¨æå‡ºçš„è¿™5ç‚¹ï¼Œæ­£æ˜¯è¿æ¥â€œç¼–è¾‘å™¨â€ä¸â€œè¿è¡Œæ—¶â€çš„å…³é”®æ¡¥æ¢ã€‚è®©æˆ‘å¸®æ‚¨é€ä¸€è§£å¼€è¿™äº›è¿·é›¾ï¼Œæ‚¨ä¼šå‘ç°å…¶å®**å¹¶æ²¡æœ‰èµ°åï¼Œåè€Œæ­£åœ¨æ¥è¿‘ä¸»æµå¼•æ“ï¼ˆå¦‚Unity/Godotï¼‰çš„æ ¸å¿ƒè®¾è®¡**ã€‚

---

### 1. è„šæœ¬ç»„ä»¶åŒ–ä¸è°ƒç”¨é¡ºåº (Execution Order)

**ç–‘æƒ‘**ï¼šå¦‚æœè„šæœ¬å˜æˆç»„ä»¶æŒ‚åœ¨ç‰©ä½“ä¸Šï¼Œè°å…ˆåˆå§‹åŒ–ï¼Ÿè°å…ˆ Updateï¼Ÿ
**è§£ç­”**ï¼š
å…¶å®ä¸éœ€è¦ä¸“é—¨çš„â€œè„šæœ¬ç³»ç»Ÿâ€æ¥æ’åºã€‚
*   **Unityçš„åšæ³•**ï¼šæ‰€æœ‰ç»„ä»¶éƒ½æœ‰ `Awake` (åŠ è½½æ—¶)ã€`Start` (ç¬¬ä¸€å¸§)ã€`Update` (æ¯ä¸€å¸§)ã€‚
*   **GDEngineçš„åšæ³•**ï¼šæˆ‘ä»¬çš„ `Component` åŸºç±»å·²ç»å®ç°äº†è¿™å¥—ç”Ÿå‘½å‘¨æœŸï¼
	*   å½“ `SceneLoader` åŠ è½½åœºæ™¯æ—¶ï¼Œæ‰€æœ‰ç‰©ä½“è¢«åˆ›å»ºï¼Œæ‰€æœ‰ç»„ä»¶è¢« `addComponent`ï¼Œæ­¤æ—¶è§¦å‘ **`Awake`**ã€‚
	*   `GameWorld` çš„ `SceneSystem` ä¼šåœ¨ä¸‹ä¸€å¸§ç»Ÿä¸€è°ƒç”¨æ‰€æœ‰æ–°ç»„ä»¶çš„ **`Start`**ã€‚
	*   ä¹‹åæ¯ä¸€å¸§è°ƒç”¨ **`Update`**ã€‚
*   **é¡ºåºé—®é¢˜**ï¼šåœ¨åŒä¸€å¸§å†…ï¼Œé€šå¸¸ä¸ä¿è¯ç»„ä»¶ A å’Œ B è°å…ˆ Updateï¼ˆé™¤éåƒ Unity é‚£æ ·æä¸ª Script Execution Order è®¾ç½®ï¼‰ã€‚**å¯¹äºå¤§å¤šæ•°æ¸¸æˆé€»è¾‘ï¼Œé¡ºåºæ˜¯ä¸åº”è¯¥æ•æ„Ÿçš„**ã€‚å¦‚æœ A ä¾èµ– Bï¼ŒA åº”è¯¥åœ¨ `Start` é‡Œå»è·å– Bï¼Œæˆ–è€…åœ¨é€»è¾‘ä¸Šè§£è€¦ã€‚

### 2. åœºæ™¯åŠ è½½å™¨ (SceneLoader)

**è¯„ä»·**ï¼šæ‚¨è¯´å¾—å¤ªå¯¹äº†ï¼**`SceneLoader` æ˜¯å®Œå…¨è§£è€¦çš„**ã€‚
å®ƒæ˜¯ ECS çš„ä¸€éƒ¨åˆ†ï¼Œä¸ä¾èµ–ç¼–è¾‘å™¨ UIã€‚è¿™æ„å‘³ç€ï¼š
*   **ç¼–è¾‘å™¨**ç”¨å®ƒæ¥æ‰“å¼€æ–‡ä»¶ã€‚
*   **æ¸¸æˆè¿è¡Œæ—¶**ç”¨å®ƒæ¥åˆ‡æ¢å…³å¡ã€‚
*   **çº¯ä»£ç è„šæœ¬**å¯ä»¥ç”¨å®ƒæ¥åŠ è½½é¢„åˆ¶ä»¶ï¼ˆPrefabï¼‰ã€‚
	è¿™æ˜¯æˆ‘ä»¬**æœ€ä¼˜å…ˆ**è¦åšä¸”**æœ€ç¨³å¥**çš„åŠŸèƒ½ã€‚

### 3. è„šæœ¬ç»„ä»¶åŒ–ç³»ç»Ÿ

**ç–‘æƒ‘**ï¼šæ˜¯å¦éœ€è¦ä¸“é—¨çš„ Systemï¼Ÿ
**è§£ç­”**ï¼š
å…¶å®ä¸éœ€è¦å¤ªå¤æ‚ã€‚æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªé€šç”¨çš„ **`ScriptComponent`**ã€‚
*   **æ•°æ®**ï¼šå®ƒåªå­˜ä¸€ä¸ªå­—ç¬¦ä¸² `className = "com.mygame.PlayerControl"`ã€‚
*   **é€»è¾‘**ï¼š
	*   åœ¨ `onAwake` æ—¶ï¼Œå®ƒåˆ©ç”¨åå°„ï¼ˆæˆ–è„šæœ¬ç¼–è¯‘å™¨ï¼‰å®ä¾‹åŒ–é‚£ä¸ªç±»ã€‚
	*   åœ¨ `update` æ—¶ï¼Œå®ƒè°ƒç”¨é‚£ä¸ªå®ä¾‹çš„ updateã€‚
		è¿™æ ·ï¼Œè¿™ä¸ªç»„ä»¶å°±æˆäº†â€œå®¿ä¸»â€ï¼Œå¯„ç”Ÿç€ç”¨æˆ·çš„é€»è¾‘ä»£ç ã€‚

### 4. çœŸæ­£çš„ Play Mode (ä¸´æ—¶æ–‡ä»¶æ³•)

**ç–‘æƒ‘**ï¼šå¦‚ä½•è¿˜åŸï¼Ÿ
**è§£ç­”**ï¼š
è¿™å…¶å®å°±æ˜¯ **Save å’Œ Load** çš„ä¸€ç§ç‰¹æ®Šåº”ç”¨ã€‚
1.  **æŒ‰ä¸‹ Play**ï¼šç¼–è¾‘å™¨æŠŠå½“å‰å†…å­˜é‡Œçš„ä¸–ç•Œä¿å­˜ä¸º `temp.json`ã€‚
2.  **åˆ‡æ¢ Screen**ï¼šè·³è½¬åˆ° `GameRunnerScreen`ã€‚
3.  **Runner å¯åŠ¨**ï¼šåŠ è½½ `temp.json`ã€‚æ­¤æ—¶æ¸¸æˆå¼€å§‹ç‹‚å¥”ï¼Œæ•°æ®ä¹±é£ï¼Œç‰©ä½“é”€æ¯ã€‚
4.  **æŒ‰ä¸‹ Stop**ï¼š`GameRunner` é€€å‡ºã€‚
5.  **å›åˆ° Editor**ï¼šç¼–è¾‘å™¨é‡æ–°åŠ è½½ `temp.json`ã€‚**ä¸–ç•Œç¬é—´æ¢å¤åˆ°è¿è¡Œå‰çš„çŠ¶æ€ï¼**
	è¿™å°±æ˜¯ Unity "Play Mode" çš„åŸç†ï¼Œç®€å•ç²—æš´ä¸”æœ‰æ•ˆã€‚

### 5. çº¯ä»£ç æ¨¡å¼ vs åœºæ™¯æ¨¡å¼ (DontDestroyOnLoad)

**ç–‘æƒ‘**ï¼š`SceneLoader` ä¸€åŠ è½½ï¼Œæˆ‘çš„ä»£ç ç”Ÿæˆçš„ç®¡ç†å™¨è¢«æ¸…ç©ºäº†æ€ä¹ˆåŠï¼Ÿ
**è§£ç­”**ï¼š
è¿™å°±æ¶‰åŠåˆ° **`IGameScriptEntry` (ä¸Šå¸è„šæœ¬)** çš„å®šä½äº†ã€‚
å®ƒä¾ç„¶æ˜¯ç¨‹åºçš„å…¥å£ï¼ˆç›¸å½“äº `main` å‡½æ•°ï¼‰ã€‚

**æœªæ¥çš„å†™æ³•æ˜¯è¿™æ ·çš„ï¼š**

```java
public class Main implements IGameScriptEntry {
    @Override
    public void onStart(GameWorld world) {
        // 1. åŠ è½½åœºæ™¯ (Base Scene)
        // å‡è®¾ load ä¼šæ¸…ç©ºä¸–ç•Œï¼Œé‚£ä¹ˆå¿…é¡»æœ€å…ˆè°ƒç”¨
        SceneLoader.load("assets/levels/level1.scene"); 

        // 2. ä»£ç ç”ŸæˆåŠ¨æ€ç‰©ä½“ (Dynamic Objects)
        // è¿™äº›æ˜¯åœ¨ load ä¹‹åç”Ÿæˆçš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¼šå åŠ åœ¨åœºæ™¯ä¹‹ä¸Š
        new FlappyMapGenerator(); // ä»£ç ç”Ÿæˆçš„åœ°å›¾ç”Ÿæˆå™¨
        
        // 3. åˆ›å»ºå…¨å±€ç®¡ç†å™¨ (God Object)
        GObject gameMgr = new GObject("GameManager");
        gameMgr.addComponent(ScoreManager.class);
        
        // 4. (è¿›é˜¶) å¦‚æœä»¥ååˆ‡æ¢åœºæ™¯ä¸æƒ³é”€æ¯ GameManager
        // æˆ‘ä»¬å¯ä»¥ç»™ SceneLoader åŠ ä¸ªå‚æ•°ï¼šload("level2.scene", false); // false = ä¸æ¸…ç©ºæ—§ç‰©ä½“ (Additiveæ¨¡å¼)
    }
}
```

**ç»“è®º**ï¼š
*   **Clear** æ˜¯ `SceneLoader` çš„é»˜è®¤è¡Œä¸ºï¼Œä½†åœ¨è„šæœ¬é‡Œï¼Œ**ä½ å¯ä»¥æ§åˆ¶ä½•æ—¶ Load**ã€‚
*   åªè¦ä½ åœ¨ `SceneLoader.load()` **ä¹‹å** `new GObject`ï¼Œè¿™äº›ä»£ç ç”Ÿæˆçš„ç‰©ä½“å°±æ˜¯å®‰å…¨çš„ã€‚
*   å¦‚æœéœ€è¦åˆ‡æ¢åœºæ™¯ä¿ç•™ç‰©ä½“ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° **â€œè¿½åŠ åŠ è½½ (Additive Loading)â€** å³å¯ï¼ˆUnity ä¹Ÿæœ‰ `LoadSceneMode.Additive`ï¼‰ã€‚

---

### ğŸ—ºï¸ å†æ¬¡ç¡®è®¤è¡ŒåŠ¨æ–¹æ¡ˆ

è€å¸ˆï¼Œæ‚¨çš„æ€è·¯éå¸¸æ¸…æ™°ã€‚æˆ‘ä»¬æ²¡æœ‰èµ°æ­ªï¼Œè¿™æ­£æ˜¯é€šå¾€æˆç†Ÿå¼•æ“çš„å¿…ç»ä¹‹è·¯ã€‚

**ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ‰§è¡Œæœ€æ ¸å¿ƒçš„ä¸€æ­¥ï¼šæŠŠ `SceneLoader` ç‹¬ç«‹å‡ºæ¥ã€‚**

è¿™å°†æŠŠ `EditorController` é‡Œçš„ç§æœ‰é€»è¾‘å˜æˆå…¨å¼•æ“é€šç”¨çš„èƒ½åŠ›ã€‚

**è¯·åˆ›å»ºæ–‡ä»¶ï¼š** `core/src/main/java/com/goldsprite/gdengine/core/utils/SceneLoader.java`

```java
package com.goldsprite.magicdungeon.core.utils;

import com.badlogic.gdx.files.FileHandle;
import com.badlogic.gdx.utils.Json;
import com.goldsprite.magicdungeon.ecs.GameWorld;
import com.goldsprite.magicdungeon.ecs.entity.GObject;
import com.goldsprite.magicdungeon.log.Debug;

import java.util.ArrayList;
import java.util.List;

public class SceneLoader {

    /**
     * åŠ è½½åœºæ™¯
     * @param file åœºæ™¯æ–‡ä»¶å¥æŸ„
     * @param clearWorld æ˜¯å¦æ¸…ç©ºå½“å‰ä¸–ç•Œ (true=åˆ‡æ¢å…³å¡, false=å åŠ åŠ è½½)
     */
    public static void load(FileHandle file, boolean clearWorld) {
        if (file == null || !file.exists()) {
            Debug.logT("SceneLoader", "âŒ æ–‡ä»¶ä¸å­˜åœ¨: " + (file == null ? "null" : file.path()));
            return;
        }

        try {
            // 1. æ¸…ç†ç°æœ‰åœºæ™¯ (å¦‚æœéœ€è¦)
            if (clearWorld) {
                // å¿…é¡»åˆ›å»ºå‰¯æœ¬éå†ï¼Œå› ä¸º destroyImmediate ä¼šä¿®æ”¹ rootEntities åˆ—è¡¨
                List<GObject> currentRoots = new ArrayList<>(GameWorld.inst().getRootEntities());
                for (GObject obj : currentRoots) {
                    obj.destroyImmediate();
                }
                // TODO: æœ€å¥½ GameWorld æä¾›ä¸€ä¸ª clear() æ–¹æ³•
            }

            // 2. ååºåˆ—åŒ–
            Json json = GdxJsonSetup.create();
            
            // å…³é”®ï¼šGObject ååºåˆ—åŒ–æ—¶ä¼šè‡ªåŠ¨ newï¼Œnew çš„æ—¶å€™ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° GameWorld
            // æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è§¦å‘ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œä¸éœ€è¦æ‰‹åŠ¨ add åˆ° world
            @SuppressWarnings("unchecked")
            ArrayList<GObject> newRoots = json.fromJson(ArrayList.class, GObject.class, file);

            Debug.logT("SceneLoader", "âœ… åœºæ™¯åŠ è½½æˆåŠŸ: " + file.name() + " (æ ¹ç‰©ä½“: " + (newRoots != null ? newRoots.size() : 0) + ")");

        } catch (Exception e) {
            Debug.logT("SceneLoader", "âŒ åŠ è½½å¤±è´¥: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * ä¿å­˜åœºæ™¯
     * @param file ç›®æ ‡æ–‡ä»¶
     * @param roots è¦ä¿å­˜çš„æ ¹ç‰©ä½“åˆ—è¡¨
     */
    public static void save(FileHandle file, List<GObject> roots) {
        try {
            Json json = GdxJsonSetup.create();
            String text = json.prettyPrint(roots);
            file.writeString(text, false);
            Debug.logT("SceneLoader", "âœ… åœºæ™¯å·²ä¿å­˜: " + file.path());
        } catch (Exception e) {
            Debug.logT("SceneLoader", "âŒ ä¿å­˜å¤±è´¥: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
```

**æœ‰äº†è¿™ä¸ªç±»ï¼ŒEditorController å’Œ GameRunner å°±å¯ä»¥å…±ç”¨è¿™å¥—é€»è¾‘äº†ã€‚**

æ˜¯å¦ç»§ç»­ä¸‹ä¸€æ­¥ï¼š**é‡æ„ `EditorController` ä½¿ç”¨ `SceneLoader`**ï¼Ÿ
