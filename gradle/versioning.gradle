
// ç‰ˆæœ¬ç®¡ç†è„šæœ¬
// ç”¨äºè‡ªåŠ¨ç®¡ç†é¡¹ç›®ç‰ˆæœ¬å·ï¼Œè§£å†³æ‰‹åŠ¨ä¿®æ”¹å¤šä¸ªæ–‡ä»¶çš„ç—›ç‚¹

def versionPropsFile = file('gradle.properties')
def androidBuildFile = file('android/build.gradle')

// è¯»å–å½“å‰ç‰ˆæœ¬
def getCurrentVersion = {
    def props = new Properties()
    versionPropsFile.withInputStream { props.load(it) }
    return props.getProperty('projectVersion')
}

// æ›´æ–°ç‰ˆæœ¬å·çš„æ ¸å¿ƒé€»è¾‘
def updateVersion = { type ->
    def props = new Properties()
    versionPropsFile.withInputStream { props.load(it) }
    
    def currentVersion = props.getProperty('projectVersion')
    def (major, minor, patch) = currentVersion.tokenize('.').collect { it.toInteger() }
    
    if (type == 'major') {
        major++
        minor = 0
        patch = 0
    } else if (type == 'minor') {
        minor++
        patch = 0
    } else if (type == 'patch') {
        patch++
    }
    
    def newVersion = "$major.$minor.$patch"
    
    // 1. æ›´æ–° gradle.properties
    def propsContent = versionPropsFile.getText('UTF-8')
    propsContent = propsContent.replaceAll(/projectVersion\s*=\s*.*/, "projectVersion=${newVersion}")
    versionPropsFile.write(propsContent, 'UTF-8')
    
    // 2. æ›´æ–° android/build.gradle (è§£å†³ AIDE+ ç¡¬ç¼–ç é—®é¢˜)
    if (androidBuildFile.exists()) {
        def androidContent = androidBuildFile.getText('UTF-8')
        // æ›¿æ¢ versionName "x.y.z"
        androidContent = androidContent.replaceAll(/versionName\s+"[^"]*"/, "versionName \"${newVersion}\"")
        // è‡ªåŠ¨å¢åŠ  versionCode
        androidContent = androidContent.replaceAll(/versionCode\s+(\d+)/) { match, code ->
            "versionCode ${code.toInteger() + 1}"
        }
        androidBuildFile.write(androidContent, 'UTF-8')
    }
    
    println "ğŸ‰ ç‰ˆæœ¬å·å·²å‡çº§: $currentVersion -> $newVersion"
    println "âœ… gradle.properties å·²æ›´æ–°"
    if (androidBuildFile.exists()) println "âœ… android/build.gradle å·²æ›´æ–° (versionName & versionCode)"
}

tasks.register('bumpPatch') {
    group = 'versioning'
    description = 'å‡çº§ä¿®è®¢å· (Bugä¿®å¤): 0.8.11 -> 0.8.12'
    doLast { updateVersion('patch') }
}

tasks.register('bumpMinor') {
    group = 'versioning'
    description = 'å‡çº§æ¬¡ç‰ˆæœ¬å· (æ–°åŠŸèƒ½): 0.8.11 -> 0.9.0'
    doLast { updateVersion('minor') }
}

tasks.register('bumpMajor') {
    group = 'versioning'
    description = 'å‡çº§ä¸»ç‰ˆæœ¬å· (é‡å¤§æ›´æ–°): 0.8.11 -> 1.0.0'
    doLast { updateVersion('major') }
}

tasks.register('printVersion') {
    group = 'versioning'
    description = 'æ‰“å°å½“å‰ç‰ˆæœ¬å·'
    doLast {
        println "Current Version: ${getCurrentVersion()}"
    }
}
