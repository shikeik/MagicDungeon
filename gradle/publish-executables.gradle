// ============================================================
// å…¨è‡ªåŠ¨å‘å¸ƒæµæ°´çº¿ (Auto Release Pipeline) - V4.0 (Final Fix)
// æ ¸å¿ƒèŒè´£:
// 1. è¯»å– RELEASE_NOTE.md ç¡®å®šç‰ˆæœ¬
// 2. å¼ºè¡ŒåŒæ­¥ gradle.propertiesã€BuildConfigã€README
// 3. è°ƒç”¨å„æ¨¡å—æ„å»º
// 4. å½’æ¡£åˆ° dist/release å¹¶æ¨é€ Git
// ============================================================

import java.nio.charset.StandardCharsets

ext {
    DIST_RELEASE_DIR = file("${rootProject.rootDir}/dist/release")
    OUTPUTS_DIR = file("${rootProject.rootDir}/outputs")
    RELEASE_NOTE_FILE = file("${rootProject.rootDir}/RELEASE_NOTE.md")
    PROP_FILE = file("${rootProject.rootDir}/gradle.properties")

    // æ ¸å¿ƒæºç æ–‡ä»¶ä½ç½® (ç”¨äºå¼ºè¡Œæ³¨å…¥ç‰ˆæœ¬)
    BUILD_CONFIG_FILE = file("${rootProject.rootDir}/core/src/main/java/com/goldsprite/gdengine/BuildConfig.java")
    README_FILE = file("${rootProject.rootDir}/README.md")
}

// --- [ç¬¬ä¸€æ­¥] é…ç½®é˜¶æ®µï¼šç¡®å®šç›®æ ‡ç‰ˆæœ¬ ---
String targetVersion = null

// 1. ä¼˜å…ˆæ£€æŸ¥å‘½ä»¤è¡Œå‚æ•° -PtargetVer=...
if (project.hasProperty("targetVer")) {
    targetVersion = project.property("targetVer")
    println "ğŸ¯ [é…ç½®] æ£€æµ‹åˆ°å‘½ä»¤è¡Œå‚æ•°ç‰ˆæœ¬: ${targetVersion}"
}
// 2. å¦åˆ™è¯»å– RELEASE_NOTE.md
else if (RELEASE_NOTE_FILE.exists()) {
    def lines = RELEASE_NOTE_FILE.readLines("UTF-8")
    if (!lines.isEmpty()) {
        def rawVer = lines[0].replace("#", "").trim()
        if (rawVer.matches(/\d+(\.\d+)+.*/)) {
            targetVersion = rawVer
            println "ğŸ“ [é…ç½®] ä»å‘å¸ƒæ–‡æ¡£è¯»å–ç‰ˆæœ¬: ${targetVersion}"
        }
    }
}

if (targetVersion == null) {
    // å¦‚æœæ²¡æ‰¾åˆ°ç‰ˆæœ¬ï¼Œä¸ºäº†ä¸è®© Gradle æŠ¥é”™ï¼Œç»™ä¸ªå ä½ç¬¦ï¼Œä½†åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä¼šæ‹¦æˆª
    targetVersion = "0.0.0.ERROR"
} else {
    // è¦†ç›–å†…å­˜ä¸­çš„ç‰ˆæœ¬ï¼Œç¡®ä¿ APK æ–‡ä»¶åç”Ÿæˆæ­£ç¡®
    allprojects {
        version = targetVersion
        project.version = targetVersion
    }
    rootProject.ext.projectVersion = targetVersion
}

// ============================================================

tasks.register('publishExecutables') {
    group = 'gdengine-publish'
    description = 'ä¸€é”®å‘å¸ƒï¼šåŒæ­¥ç‰ˆæœ¬->æ„å»º->å½’æ¡£->Gitæäº¤'

    // 0. å®‰å…¨æ‹¦æˆª
    if (targetVersion.contains("ERROR")) {
        throw new GradleException("âŒ æ— æ³•ç¡®å®šå‘å¸ƒç‰ˆæœ¬ï¼è¯·ç¡®ä¿ RELEASE_NOTE.md ç¬¬ä¸€è¡Œä¸ºç‰ˆæœ¬å· (å¦‚ 1.10.12.21)")
    }

    // 1. å»ºç«‹ä»»åŠ¡ä¾èµ– (ä½¿ç”¨ project å¼•ç”¨ï¼Œé¿å…å­—ç¬¦ä¸²è·¯å¾„è§£æé”™è¯¯)
    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ evaluationDependsOn ç¡®ä¿å­é¡¹ç›®å·²é…ç½®
    evaluationDependsOn(':core')
    evaluationDependsOn(':lwjgl3')
    evaluationDependsOn(':android')

    dependsOn project(':core').tasks.getByName('compileJava') // ç¡®ä¿æ ¸å¿ƒç¼–è¯‘
    dependsOn project(':core').tasks.getByName('copyEngineLibs')
    dependsOn project(':core').tasks.getByName('packageEngineCore')
    dependsOn project(':lwjgl3').tasks.getByName('jar')       // PC JAR
    dependsOn project(':android').tasks.getByName('assembleRelease') // Android APK

    // [æ–°å¢] ç¡®ä¿ç”Ÿæˆæœ€æ–°çš„ Changelog å’Œæ–‡æ¡£åˆ†å‘åŒ…
    dependsOn rootProject.tasks.named('generateChangelog')
    dependsOn rootProject.tasks.named('buildDocsDist')

    // 2. [æ ¸å¿ƒ] æ‰§è¡Œå‰çš„ç¯å¢ƒå‡†å¤‡ä¸æ–‡ä»¶ä¿®æ”¹
    doFirst {
        println "ğŸš€ [1/5] å¼€å§‹å‘å¸ƒæµç¨‹: ${targetVersion}"

        // A. ç‰©ç†æ›´æ–° gradle.properties (æŒä¹…åŒ–)
        updatePropertiesFile(targetVersion)

        // B. å¼ºè¡Œæ›´æ–° BuildConfig.java (è§£å†³ Core æ¨¡å—é…ç½®é˜¶æ®µä»»åŠ¡æ»åçš„é—®é¢˜)
        forceUpdateBuildConfig(targetVersion)

        // C. å¼ºè¡Œæ›´æ–° README.md
        forceUpdateReadme(targetVersion)

        // D. æ¸…ç†å‘å¸ƒç›®å½•
        println "ğŸ§¹ [2/5] æ¸…ç†å‘å¸ƒç›®å½• (dist/release)..."
        delete DIST_RELEASE_DIR
        DIST_RELEASE_DIR.mkdirs()
    }

    // 3. å½’æ¡£ä¸ Git æ“ä½œ
    doLast {
        println "ğŸ“¦ [4/5] å½’æ¡£äº§ç‰©..."

        def expectedApk = "MagicDungeon_V${targetVersion}.apk"
        def expectedJar = "MagicDungeon_V${targetVersion}.jar"

        // æ‰§è¡Œæ¬è¿
        copy {
            from OUTPUTS_DIR
            into DIST_RELEASE_DIR
            // ç²¾ç¡®åŒ¹é…ï¼Œç»ä¸å«ç³Š
            include expectedJar
            include expectedApk
            // é¢„ç•™ EXE
            include "MagicDungeon_V${targetVersion}.exe"
        }

        // æ ¡éªŒäº§ç‰©
        File distApk = new File(DIST_RELEASE_DIR, expectedApk)
        if (!distApk.exists()) {
            println "âŒ [ä¸¥é‡é”™è¯¯] APK äº§ç‰©æœªæ‰¾åˆ°: ${expectedApk}"
            println "   è¯·æ£€æŸ¥ Android æ„å»ºæ—¥å¿—ï¼Œç¡®è®¤ app-release.jks ç­¾åæ˜¯å¦é…ç½®æ­£ç¡®ã€‚"
            throw new GradleException("APK æ„å»ºå¤±è´¥")
        }

        println "âœ… äº§ç‰©å·²å°±ç»ª: dist/release/ (APK & JAR)"

        // --- Git è‡ªåŠ¨åŒ– ---
        println "ğŸ™ [5/5] æ‰§è¡Œ Git è‡ªåŠ¨åŒ–æµç¨‹..."

        // 1. æ·»åŠ æ‰€æœ‰å˜åŠ¨ (åŒ…æ‹¬ gradle.properties, BuildConfig, dist é‡Œçš„äºŒè¿›åˆ¶)
        runCmd("git add .")

        // 2. æäº¤
        runCmd("git commit -m \"chore: release ${targetVersion}\"")

        // 3. å¤„ç† Tag
        // å°è¯•åˆ é™¤æœ¬åœ°åŒå tag (é˜²æ­¢é‡æ‰“æŠ¥é”™)
        try { runCmd("git tag -d ${targetVersion}") } catch(ignored){}

        // ä½¿ç”¨ -F è¯»å– RELEASE_NOTE.md ä½œä¸º Tag è¯´æ˜
        runCmd("git tag -a ${targetVersion} -F RELEASE_NOTE.md")

        // 4. æ¨é€
        println "ğŸš€ æ­£åœ¨æ¨é€åˆ°è¿œç¨‹ä»“åº“ (ä»£ç  + Tag)..."
        runCmd("git push origin main")
				// [ä¿®æ”¹] å¢åŠ  --force å‚æ•°ï¼Œå¼ºåˆ¶è¦†ç›–è¿œç¨‹å·²å­˜åœ¨çš„åŒå Tag
				runCmd("git push origin ${targetVersion} --force")

        println "\nğŸ‰ğŸ‰ğŸ‰ å‘å¸ƒæµç¨‹å…¨éƒ¨å®Œæˆï¼ç‰ˆæœ¬: ${targetVersion} ğŸ‰ğŸ‰ğŸ‰"
        println "ğŸ‘‰ GitHub Actions å°†ä¼šè‡ªåŠ¨åˆ†å‘ release é™„ä»¶ã€‚"
        println "ğŸ‘‰ å¼•æ“æ–‡æ¡£ä¸‹è½½é¡µå°†è‡ªåŠ¨æ›´æ–°é“¾æ¥ã€‚"
    }
}

// ============================================================
// è¾…åŠ©æ–¹æ³•åŒº
// ============================================================

def updatePropertiesFile(String newVer) {
    if (!PROP_FILE.exists()) return
    def lines = PROP_FILE.readLines("UTF-8")
    def outLines = []
    boolean updated = false
    for (String line : lines) {
        if (line.trim().startsWith("projectVersion")) {
            outLines.add("projectVersion=${newVer}")
            updated = true
        } else {
            outLines.add(line)
        }
    }
    if (updated) {
        PROP_FILE.withWriter("UTF-8") { writer -> outLines.forEach { writer.writeLine(it) } }
        println "ğŸ’¾ å·²æ›´æ–° gradle.properties -> ${newVer}"
    }
}

def forceUpdateBuildConfig(String newVer) {
    if (!BUILD_CONFIG_FILE.exists()) {
        println "âš ï¸ æœªæ‰¾åˆ° BuildConfig.javaï¼Œè·³è¿‡æ›´æ–°"
        return
    }
    def content = BUILD_CONFIG_FILE.getText("UTF-8")
    // ä½¿ç”¨æ­£åˆ™æ›¿æ¢ DEV_VERSION = "..."
    def newContent = content.replaceAll(/DEV_VERSION = ".*?"/, "DEV_VERSION = \"${newVer}\"")
    BUILD_CONFIG_FILE.write(newContent, "UTF-8")
    println "ğŸ’¾ å·²å¼ºè¡Œæ›´æ–° BuildConfig.java -> ${newVer}"
}

def forceUpdateReadme(String newVer) {
    if (!README_FILE.exists()) return
    def content = README_FILE.getText("UTF-8")
    // æ›¿æ¢ # MagicDungeon ... Vxxx
    // å‡è®¾ README æ ‡é¢˜æ ¼å¼ç›¸å¯¹å›ºå®š
    def newContent = content.replaceFirst(/V\d+(\.\d+)+/, "V${newVer}")
    README_FILE.write(newContent, "UTF-8")
    println "ğŸ’¾ å·²æ›´æ–° README.md æ ‡é¢˜ -> V${newVer}"
}

def runCmd(String cmd) {
    println "   > ${cmd}"
    def isWin = System.getProperty("os.name").toLowerCase().contains("windows")
    def proc = isWin ? ["cmd", "/c", cmd].execute(null, rootProject.rootDir) : ["bash", "-c", cmd].execute(null, rootProject.rootDir)
    proc.waitFor()
    if (proc.exitValue() != 0) {
        println "âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${cmd}"
        println "   é”™è¯¯ä¿¡æ¯: " + proc.err.text
        throw new GradleException("Git æ“ä½œå¤±è´¥")
    }
}
