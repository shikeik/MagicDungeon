import org.gradle.internal.jvm.Jvm
import java.nio.charset.Charset

// jpackage æ‰“åŒ…ä»»åŠ¡é…ç½®
// æ”¾åœ¨ lwjgl3/build.gradle ä¸­å¼•ç”¨

// è·å– JDK ç‰ˆæœ¬
def javaVersion = Jvm.current().javaVersion.majorVersion.toInteger()
if (javaVersion < 14) {
    logger.warn("âš ï¸ å½“å‰ JDK ç‰ˆæœ¬ä¸º ${javaVersion}, jpackage éœ€è¦ JDK 14+. ä»»åŠ¡å¯èƒ½æ— æ³•è¿è¡Œ.")
}

// è¾…åŠ©æ–¹æ³•ï¼šæ‰§è¡Œå‘½ä»¤å¹¶å¤„ç†ä¹±ç  (é»˜è®¤ä½¿ç”¨ GBK è¯»å– Windows å‘½ä»¤è¡Œè¾“å‡º)
def runCommand(List<String> command, File workingDir, String charset = 'GBK') {
    // ç¡®ä¿æ‰€æœ‰å‚æ•°éƒ½æ˜¯ String ç±»å‹ï¼Œé¿å… GString å¯¼è‡´çš„ç±»å‹ä¸åŒ¹é…
    def safeCommand = command.collect { it.toString() }
    println "Executing: ${safeCommand.join(' ')}"
    def pb = new ProcessBuilder(safeCommand)
    pb.directory(workingDir)
    pb.redirectErrorStream(true)
    def process = pb.start()
    process.outputStream.close() // å…³é—­æ ‡å‡†è¾“å…¥ï¼Œé˜²æ­¢è¿›ç¨‹ç­‰å¾…è¾“å…¥
    
    try {
        process.inputStream.eachLine(charset) { line ->
            println line
        }
    } catch (Exception e) {
        println "Error reading output: ${e.message}"
    }
    
    process.waitFor()
    if (process.exitValue() != 0) {
        throw new GradleException("Command failed with exit code ${process.exitValue()}")
    }
}

tasks.register('jpackageExe') {
    group = 'distribution'
    description = 'ä½¿ç”¨ jpackage æ‰“åŒ…ä¸ºè‡ªå¸¦è¿è¡Œæ—¶çš„åº”ç”¨ç¨‹åºé•œåƒ (App Image)'
    dependsOn 'jar'

    // é…ç½®è·¯å¾„
    def rootDir = rootProject.projectDir
    def appName = rootProject.name
    // ä½¿ç”¨ rootProject.findProperty é¿å…åœ¨å­é¡¹ç›®ä¸­æ‰¾ä¸åˆ°å±æ€§
    def projectVersion = rootProject.findProperty('projectVersion')
    def jarName = "${appName}_V${projectVersion}.jar"
    def inputJar = file("${rootDir}/outputs/${jarName}")
    
    // ä¸´æ—¶è¾“å…¥ç›®å½• (ç”¨äºéš”ç¦» jpackage è¾“å…¥)
    def stagingDir = file("${project.buildDir}/jpackage-staging")
    // è¾“å‡ºç›®å½• (æ”¹ä¸º outputs/jpackage/)
    def outputDir = file("${rootDir}/outputs/jpackage")
    
    // å›¾æ ‡
    def iconPath = "${rootDir}/assets/icon.ico"
    
    // ä¸»ç±»
    def mainClass = project.mainClassName

    doLast {
        if (!inputJar.exists()) {
            throw new GradleException("æ‰¾ä¸åˆ°è¾“å…¥ Jar æ–‡ä»¶: ${inputJar}\nè¯·ç¡®ä¿ jar ä»»åŠ¡å·²æˆåŠŸè¿è¡Œ.")
        }
        
        // æ¸…ç†å¹¶é‡æ–°åˆ›å»º staging ç›®å½•
        delete stagingDir
        stagingDir.mkdirs()
        
        // å¤åˆ¶ Jar åˆ° staging ç›®å½•
        copy {
            from inputJar
            into stagingDir
        }
        
        // æ¸…ç†è¾“å‡ºç›®å½• (åªæ¸…ç† outputs/jpackage, é¿å…è¯¯åˆ å…¶ä»–æ„å»ºäº§ç‰©)
        delete outputDir
        
        println "ğŸ“¦ å¼€å§‹ä½¿ç”¨ jpackage æ‰“åŒ…..."
        println "   - è¾“å…¥ Jar: ${jarName}"
        println "   - è¾“å‡ºç›®å½•: ${outputDir}"
        println "   - ä¸»ç±»: ${mainClass}"

        // jpackage å‘½ä»¤
        def cmd = [
            'jpackage',
            '--type', 'app-image',
            '--dest', outputDir.absolutePath,
            '--input', stagingDir.absolutePath,
            '--name', appName,
            '--main-jar', jarName,
            '--main-class', mainClass,
            '--icon', iconPath,
            '--java-options', '-Xmx1G -Dfile.encoding=UTF-8',
            '--verbose'
        ]
        
        // æ‰§è¡Œå‘½ä»¤ (Windows ä¸‹ jpackage è¾“å‡ºé€šå¸¸æ˜¯ GBK)
        runCommand(cmd, project.projectDir)

        println "âœ… åº”ç”¨ç¨‹åºé•œåƒå·²ç”Ÿæˆ: ${outputDir}/${appName}"
        println "ğŸ‘‰ æ‚¨å¯ä»¥è¿è¡Œ ${outputDir}/${appName}/${appName}.exe æ¥å¯åŠ¨æ¸¸æˆ (æ— éœ€å·²å®‰è£…çš„ JRE)"
        println "ğŸ‘‰ è‹¥éœ€åˆ¶ä½œå•æ–‡ä»¶ EXE, è¯·é…ç½® Enigma Virtual Box å¹¶è¿è¡Œ packageSingleExe ä»»åŠ¡."
    }
}

// æ³¨å†Œ Enigma Virtual Box æ‰“åŒ…ä»»åŠ¡
tasks.register('packageSingleExe') {
    group = 'distribution'
    description = 'ä½¿ç”¨ Enigma Virtual Box å°† App Image æ‰“åŒ…ä¸ºå•æ–‡ä»¶ Exe (éœ€è¦é…ç½® enigmavb.path)'
    dependsOn 'jpackageExe'
    
    doLast {
        // å°è¯•ä» local.properties è¯»å–è·¯å¾„
        def evbPath = null
        def localPropsFile = rootProject.file('local.properties')
        if (localPropsFile.exists()) {
            Properties p = new Properties()
            p.load(new FileInputStream(localPropsFile))
            evbPath = p.getProperty('enigmavb.path')
        }
        
        // é»˜è®¤è·¯å¾„å°è¯• (æ£€æŸ¥å¸¸è§çš„å®‰è£…ä½ç½®)
        if (!evbPath) {
            def possiblePaths = [
                "${rootProject.projectDir}/tools/EnigmaVirtualBox/enigmavbconsole.exe", // ä¼˜å…ˆä½¿ç”¨é¡¹ç›®å†…åµŒå·¥å…·
                "C:/Program Files/Enigma Virtual Box/enigmavbconsole.exe",
                "C:/Program Files (x86)/Enigma Virtual Box/enigmavbconsole.exe",
                "D:/Program Files/Enigma Virtual Box/enigmavbconsole.exe",
                "E:/WorkApps/Enigma Virtual Box/enigmavbconsole.exe" // å¢åŠ ç”¨æˆ·æ—¥å¿—ä¸­çš„è·¯å¾„
            ]
            for (String path : possiblePaths) {
                if (file(path).exists()) {
                    evbPath = path
                    break
                }
            }
        }

        def appName = rootProject.name
        def projectVersion = rootProject.findProperty('projectVersion')
        // jpackage è¾“å‡ºçš„ç›®å½•é€šå¸¸æ˜¯ outputs/jpackage/${appName}
        def distDir = file("${rootProject.projectDir}/outputs/jpackage/${appName}")
        // å•æ–‡ä»¶è¾“å‡ºè·¯å¾„: outputs/${appName}_V${projectVersion}.exe
        def outputExe = file("${rootProject.projectDir}/outputs/${appName}_V${projectVersion}.exe")
        
        // æ£€æŸ¥å·¥å…·æ˜¯å¦å­˜åœ¨
        if (!evbPath || !file(evbPath).exists()) {
            println "\nâš ï¸ [è­¦å‘Š] æ— æ³•æ‰§è¡Œå•æ–‡ä»¶æ‰“åŒ…"
            println "è¯·åœ¨ local.properties ä¸­é…ç½® 'enigmavb.path' æŒ‡å‘ enigmavbconsole.exe"
            println "æˆ–è€…å°† Enigma Virtual Box å®‰è£…åˆ°é»˜è®¤è·¯å¾„: C:/Program Files/Enigma Virtual Box/"
            return
        }

        // åŠ¨æ€ç”Ÿæˆ EVB é¡¹ç›®æ–‡ä»¶
        // ä¸å†ä¾èµ– template.evb æ¨¡æ¿ï¼Œè€Œæ˜¯æ ¹æ® jpackage çš„è¾“å‡ºåŠ¨æ€æ„å»º XML
        println "ğŸ“ æ­£åœ¨åŠ¨æ€ç”Ÿæˆ Enigma Virtual Box é¡¹ç›®æ–‡ä»¶..."
        
        // å®šä¹‰è¾“å…¥ EXE (jpackage ç”Ÿæˆçš„ä¸»ç¨‹åº)
        def inputExe = new File(distDir, "${appName}.exe")
        if (!inputExe.exists()) {
             throw new GradleException("æ‰¾ä¸åˆ° jpackage ç”Ÿæˆçš„ä¸»ç¨‹åº: ${inputExe}")
        }

        // é€’å½’é—­åŒ…ï¼šç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
        def generateFiles
        generateFiles = { builder, File currentDir ->
            currentDir.eachFile { f ->
                // è·³è¿‡ä¸»ç¨‹åºæœ¬èº«ï¼Œé¿å…ä½œä¸ºè™šæ‹Ÿæ–‡ä»¶é‡å¤æ‰“åŒ…
                if (f.absolutePath == inputExe.absolutePath) return 
                
                if (f.isDirectory()) {
                    builder.File {
                        Type('3')
                        Name(f.name)
                        Action('0')
                        OverwriteDateTime('False')
                        OverwriteAttributes('False')
                        HideFromDialogs('0')
                        Files {
                            generateFiles(builder, f)
                            
                            // ã€ä¿®å¤ã€‘å¤„ç† .cfg æ–‡ä»¶åä¸åŒ¹é…é—®é¢˜
                            // jpackage ç”Ÿæˆçš„ exe å¯èƒ½ä¼šæŸ¥æ‰¾ <ExeName>.cfg
                            // ä½†æˆ‘ä»¬çš„å•æ–‡ä»¶ exe æ˜¯å¸¦ç‰ˆæœ¬å·çš„ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°é»˜è®¤çš„ cfg
                            // æ‰€ä»¥å¦‚æœç›®å½•ä¸‹å­˜åœ¨ appName.cfgï¼Œæˆ‘ä»¬é¢å¤–åˆ›å»ºä¸€ä¸ª appName_Version.cfg çš„æ˜ å°„
                            if (f.name == 'app') {
                                def defaultCfg = new File(f, "${appName}.cfg")
                                if (defaultCfg.exists()) {
                                    def versionedCfgName = "${appName}_V${projectVersion}.cfg"
                                    println "   - [Fix] æ·»åŠ é…ç½®æ–‡ä»¶æ˜ å°„: ${versionedCfgName} -> ${defaultCfg.name}"
                                    
                                    builder.File {
                                        Type('2')
                                        Name(versionedCfgName) // è™šæ‹Ÿæ–‡ä»¶åå¸¦ç‰ˆæœ¬å·
                                        File(defaultCfg.absolutePath) // æŒ‡å‘åŒä¸€ä¸ªæºæ–‡ä»¶
                                        ActiveX('False')
                                        ActiveXInstall('False')
                                        Action('0')
                                        OverwriteDateTime('False')
                                        OverwriteAttributes('False')
                                        PassCommandLine('False')
                                        HideFromDialogs('0')
                                    }
                                }
                            }
                        }
                    }
                } else {
                    builder.File {
                        Type('2')
                        Name(f.name)
                        File(f.absolutePath)
                        ActiveX('False')
                        ActiveXInstall('False')
                        Action('0')
                        OverwriteDateTime('False')
                        OverwriteAttributes('False')
                        PassCommandLine('False')
                        HideFromDialogs('0')
                    }
                }
            }
        }
        
        // ä¿å­˜ä¸ºä¸´æ—¶ evb æ–‡ä»¶ (æ”¾åœ¨æ ¹ç›®å½•)
        def tempEvb = file("${rootDir}/temp_build.evb")
        
        // ä½¿ç”¨ withWriter ç¡®ä¿ç¼–ç æ­£ç¡®ä¸”è‡ªåŠ¨å¤„ç†èµ„æºé‡Šæ”¾
        tempEvb.withWriter('UTF-8') { writer ->
            // æ‰‹åŠ¨å†™å…¥ XML å£°æ˜ (æ³¨æ„æ¢è¡Œç¬¦)
            writer.write("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n")
            
            // ä½¿ç”¨ MarkupBuilder ç”Ÿæˆå†…å®¹
            def xml = new groovy.xml.MarkupBuilder(writer)
            
            // æ„å»º XML ç»“æ„
            xml.EnigmaVirtualBox {
                InputFile(inputExe.absolutePath)
                OutputFile(outputExe.absolutePath)
                Files {
                    Enabled('True')
                    DeleteExtractedOnExit('False')
                    CompressFiles('False')
                    Files {
                        File {
                            Type('3')
                            Name('%DEFAULT FOLDER%')
                            Action('0')
                            OverwriteDateTime('False')
                            OverwriteAttributes('False')
                            HideFromDialogs('0')
                            Files {
                                // é€’å½’æ·»åŠ  distDir ä¸‹çš„æ‰€æœ‰å†…å®¹
                                generateFiles(xml, distDir)
                            }
                        }
                    }
                }
            }
        }
        
        println "   - ä¸´æ—¶é…ç½®å·²ç”Ÿæˆ: ${tempEvb}"

        def cmd = [evbPath, tempEvb.absolutePath]
        
        // Enigma Console ä¹Ÿæ˜¯ Windows ç¨‹åºï¼Œé€šå¸¸è¾“å‡º GBK
        runCommand(cmd, project.projectDir)
        
        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        tempEvb.delete()
        
        println "âœ… å•æ–‡ä»¶æ‰“åŒ…å®Œæˆï¼"
        println "ğŸ‘‰ æ–‡ä»¶å·²ç”Ÿæˆ: ${outputExe}"
    }
}
