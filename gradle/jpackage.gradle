
// jpackage æ‰“åŒ…ä»»åŠ¡é…ç½®
// æ”¾åœ¨ lwjgl3/build.gradle ä¸­å¼•ç”¨

// è·å– JDK ç‰ˆæœ¬
def javaVersion = org.gradle.internal.jvm.Jvm.current().javaVersion.majorVersion.toInteger()
if (javaVersion < 14) {
    logger.warn("âš ï¸ å½“å‰ JDK ç‰ˆæœ¬ä¸º ${javaVersion}, jpackage éœ€è¦ JDK 14+. ä»»åŠ¡å¯èƒ½æ— æ³•è¿è¡Œ.")
}

tasks.register('packageApp', Exec) {
    group = 'distribution'
    description = 'ä½¿ç”¨ jpackage æ‰“åŒ…ä¸ºè‡ªå¸¦è¿è¡Œæ—¶çš„åº”ç”¨ç¨‹åºé•œåƒ (App Image)'
    
    dependsOn 'jar'

    // é…ç½®è·¯å¾„
    def rootDir = rootProject.projectDir
    def appName = rootProject.name
    // ä½¿ç”¨ rootProject.findProperty é¿å…åœ¨å­é¡¹ç›®ä¸­æ‰¾ä¸åˆ°å±æ€§
    def projectVersion = rootProject.findProperty('projectVersion')
    def jarName = "${appName}_V${projectVersion}.jar"
    def inputJar = file("${rootDir}/outputs/${jarName}")
    
    // ä¸´æ—¶è¾“å…¥ç›®å½• (ç”¨äºéš”ç¦» jpackage è¾“å…¥)
    def stagingDir = file("${project.buildDir}/jpackage-staging")
    // è¾“å‡ºç›®å½•
    def outputDir = file("${rootDir}/outputs/dist")
    
    // å›¾æ ‡
    def iconPath = "${rootDir}/assets/icon.ico"
    
    // ä¸»ç±»
    def mainClass = project.mainClassName

    // å‡†å¤‡è¾“å…¥æ–‡ä»¶
    doFirst {
        if (!inputJar.exists()) {
            throw new GradleException("æ‰¾ä¸åˆ°è¾“å…¥ Jar æ–‡ä»¶: ${inputJar}\nè¯·ç¡®ä¿ jar ä»»åŠ¡å·²æˆåŠŸè¿è¡Œ.")
        }
        
        // æ¸…ç†å¹¶é‡æ–°åˆ›å»º staging ç›®å½•
        delete stagingDir
        stagingDir.mkdirs()
        
        // å¤åˆ¶ Jar åˆ° staging ç›®å½•
        copy {
            from inputJar
            into stagingDir
        }
        
        // æ¸…ç†è¾“å‡ºç›®å½•
        delete outputDir
        
        println "ğŸ“¦ å¼€å§‹ä½¿ç”¨ jpackage æ‰“åŒ…..."
        println "   - è¾“å…¥ Jar: ${jarName}"
        println "   - è¾“å‡ºç›®å½•: ${outputDir}"
        println "   - ä¸»ç±»: ${mainClass}"
    }

    // jpackage å‘½ä»¤
    commandLine 'jpackage',
            '--type', 'app-image',
            '--dest', outputDir,
            '--input', stagingDir,
            '--name', appName,
            '--main-jar', jarName,
            '--main-class', mainClass,
            '--icon', iconPath,
            '--java-options', '-Xmx1G -Dfile.encoding=UTF-8',
            '--verbose'
            
    doLast {
        println "âœ… åº”ç”¨ç¨‹åºé•œåƒå·²ç”Ÿæˆ: ${outputDir}/${appName}"
        println "ğŸ‘‰ æ‚¨å¯ä»¥è¿è¡Œ ${outputDir}/${appName}/${appName}.exe æ¥å¯åŠ¨æ¸¸æˆ (æ— éœ€å·²å®‰è£…çš„ JRE)"
        println "ğŸ‘‰ è‹¥éœ€åˆ¶ä½œå•æ–‡ä»¶ EXE, è¯·é…ç½® Enigma Virtual Box å¹¶è¿è¡Œ packageSingleExe ä»»åŠ¡."
    }
}

// å°è¯•æ³¨å†Œ Enigma Virtual Box æ‰“åŒ…ä»»åŠ¡
tasks.register('packageSingleExe', Exec) {
    group = 'distribution'
    description = 'ä½¿ç”¨ Enigma Virtual Box å°† App Image æ‰“åŒ…ä¸ºå•æ–‡ä»¶ Exe (éœ€è¦é…ç½® enigmavb.path)'
    dependsOn 'packageApp'
    
    // å°è¯•ä» local.properties è¯»å–è·¯å¾„
    def evbPath = null
    def localPropsFile = rootProject.file('local.properties')
    if (localPropsFile.exists()) {
        Properties p = new Properties()
        p.load(new FileInputStream(localPropsFile))
        evbPath = p.getProperty('enigmavb.path')
    }
    
    // é»˜è®¤è·¯å¾„å°è¯•
    if (!evbPath) {
        def defaultPath = "C:/Program Files (x86)/Enigma Virtual Box/enigmavbconsole.exe"
        if (file(defaultPath).exists()) {
            evbPath = defaultPath
        }
    }

    def appName = rootProject.name
    def distDir = file("${rootProject.projectDir}/outputs/dist/${appName}")
    def outputExe = "${rootProject.projectDir}/outputs/${appName}_Portable_V${rootProject.findProperty('projectVersion')}.exe"
    
    // æ£€æŸ¥å·¥å…·æ˜¯å¦å­˜åœ¨
    if (!evbPath || !file(evbPath).exists()) {
        // å¦‚æœæ‰¾ä¸åˆ°å·¥å…·ï¼Œä½¿ç”¨ echo æ‰“å°è­¦å‘Šå¹¶æ­£å¸¸é€€å‡º (ä¸é˜»å¡æ„å»ºï¼Œä½†æç¤ºç”¨æˆ·)
        commandLine 'cmd', '/c', 'echo', 'âš ï¸ æœªæ‰¾åˆ° Enigma Virtual Box (enigmavbconsole.exe), è·³è¿‡å•æ–‡ä»¶æ‰“åŒ….'
        doLast {
            println "\nâš ï¸ [è­¦å‘Š] æ— æ³•æ‰§è¡Œå•æ–‡ä»¶æ‰“åŒ…"
            println "è¯·åœ¨ local.properties ä¸­é…ç½® 'enigmavb.path' æŒ‡å‘ enigmavbconsole.exe"
            println "æˆ–è€…å°† Enigma Virtual Box å®‰è£…åˆ°é»˜è®¤è·¯å¾„: C:/Program Files (x86)/Enigma Virtual Box/"
        }
    } else {
        // å¦‚æœæ‰¾åˆ°äº†å·¥å…·ï¼Œå°è¯•æ‰“åŒ…
        // æ³¨æ„: è¿™é‡Œå‡è®¾ç”¨æˆ·å·²ç»é…ç½®å¥½äº† template.evb æˆ–è€…æˆ‘ä»¬å°è¯•ç›´æ¥æ‰“åŒ… (å¦‚æœæ”¯æŒçš„è¯)
        // å®é™…ä¸Š EnigmaVB Console éœ€è¦é¡¹ç›®æ–‡ä»¶ã€‚
        // æˆ‘ä»¬è¿™é‡Œæš‚æ—¶åªæ‰“å°â€œå·¥å…·å·²æ‰¾åˆ°ï¼Œä½†ç¼ºå°‘æ¨¡æ¿â€æç¤ºï¼Œé™¤éæˆ‘ä»¬å®ç°äº†æ¨¡æ¿ç”Ÿæˆã€‚
        
        commandLine 'cmd', '/c', 'echo', "âœ… æ‰¾åˆ° EnigmaVB: ${evbPath}"
        
        doLast {
            println "ğŸš€ å•æ–‡ä»¶æ‰“åŒ…è‡ªåŠ¨åŒ–åŠŸèƒ½å¼€å‘ä¸­..."
            println "è¯·æ‰‹åŠ¨ä½¿ç”¨ Enigma Virtual Box æ‰“åŒ…ç›®å½•: ${distDir}"
        }
    }
}
