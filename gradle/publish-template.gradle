import java.security.MessageDigest
import groovy.json.JsonOutput
import java.text.SimpleDateFormat // æ–°å¢

// ============================================================
// æ¨¡æ¿å‘å¸ƒæµæ°´çº¿ (v2.0: åŠ¨é™åˆ†ç¦»ç‰ˆ)
// ç”¨æ³•: gradlew publishTemplate -Ptarget=BigDemo
// ============================================================

ext {
	CHUNK_SIZE = 18 * 1024 * 1024 // 18 MB
	TEMPLATES_ROOT = file("MagicDungeon/InternalTemplates")
	BUILD_TMP = file("build/tmp_tpl_publish")
	DIST_ROOT = file("dist/templates")
}

tasks.register('publishTemplate') {
	group = 'gdengine-publish'
	description = 'Package, Split and Manifest a specific template.'

	doLast {
		// 1. è·å–ç›®æ ‡å‚æ•°
		if (!project.hasProperty('target')) {
			throw new GradleException("è¯·æŒ‡å®šç›®æ ‡æ¨¡æ¿! ç”¨æ³•: -Ptarget=TemplateName")
		}
		String targetName = project.property('target')
		File sourceDir = new File(TEMPLATES_ROOT, targetName)

		if (!sourceDir.exists()) {
			throw new GradleException("æ¨¡æ¿ç›®å½•ä¸å­˜åœ¨: ${sourceDir.absolutePath}")
		}

		// 2. ç”Ÿæˆ BuildID (å¼ºåˆ¶åˆ·æ–°ç¼“å­˜çš„å…³é”®)
		def dateFormat = new SimpleDateFormat("yyyyMMdd_HHmmss")
		dateFormat.setTimeZone(TimeZone.getTimeZone("Asia/Shanghai"))
		def buildID = dateFormat.format(new Date())

		println "ğŸ“¦ æ­£åœ¨å¤„ç†æ¨¡æ¿: ${targetName} (ID: ${buildID})"

		// 3. å‡†å¤‡ç›®å½•
		BUILD_TMP.deleteDir()
		BUILD_TMP.mkdirs()

		File targetDistDir = new File(DIST_ROOT, targetName)
		if (!targetDistDir.exists()) targetDistDir.mkdirs()

		// [æ¸…ç†æ—§æ–‡ä»¶] åˆ é™¤ manifest.json å’Œ è¯¥æ¨¡æ¿çš„æ‰€æœ‰æ—§åˆ†å·
		// åŒ¹é…è§„åˆ™: manifest.json æˆ– targetName.* (é˜²æ­¢è¯¯åˆ å…¶ä»–æ–‡ä»¶)
		targetDistDir.listFiles().each { f ->
			if (f.isFile() && (f.name == "manifest.json" || f.name.startsWith("${targetName}."))) {
				f.delete()
			}
		}

		// 4. æ‰“åŒ… Zip
		println "   -> æ­£åœ¨å‹ç¼©..."
		File zipFile = new File(BUILD_TMP, "${targetName}.zip")
		ant.zip(destfile: zipFile, basedir: sourceDir)

		def sizeMb = zipFile.length() / (1024.0 * 1024.0)
		println "   -> å‹ç¼©å®Œæˆ: ${String.format('%.2f', sizeMb)} MB"

		// 5. åˆ‡åˆ†
		println "   -> æ­£åœ¨åˆ‡åˆ† (æ¯å· ${CHUNK_SIZE/1024/1024}MB)..."
		def partsList = []
		def buffer = new byte[CHUNK_SIZE]
		int partIndex = 0

		zipFile.withInputStream { ins ->
			while (true) {
				int bytesRead = ins.read(buffer)
				if (bytesRead <= 0) break

				// [æ ¸å¿ƒ] å‘½åè§„åˆ™: Name.BuildID.pIndex.zip
				// ä¾‹å¦‚: BigDemo.20260120_120000.p0.zip
				String partName = String.format("${targetName}.%s.p%d.zip", buildID, partIndex)
				File partFile = new File(targetDistDir, partName)

				partFile.withOutputStream { outs ->
					outs.write(buffer, 0, bytesRead)
				}

				String md5 = generateMD5(partFile)

				// Manifest åªå­˜ç›¸å¯¹æ–‡ä»¶å
				partsList << [
					index: partIndex,
					file: partName,
					md5: md5,
					size: partFile.length()
				]

				def partSize = partFile.length() / (1024.0 * 1024.0)
				println "      Generated: ${partName} (${String.format('%.2f', partSize)} MB)"
				partIndex++
			}
		}

		// 6. ç”Ÿæˆ Manifest
		def manifest = [
			id: targetName,
			name: "${targetName}.zip",
			totalSize: zipFile.length(),
			version: "1.0", // æ¨¡æ¿è‡ªèº«çš„ç‰ˆæœ¬é€»è¾‘æš‚æ—¶ä¿ç•™
			buildId: buildID, // å†™å…¥ ID
			updatedAt: new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("Asia/Shanghai")),
			parts: partsList
		]

		File jsonFile = new File(targetDistDir, "manifest.json")
		jsonFile.text = JsonOutput.prettyPrint(JsonOutput.toJson(manifest))

		println "âœ… å‘å¸ƒå®Œæˆï¼äº§ç‰©ä½äº: ${targetDistDir}"
		println "ğŸš€ è¯·å°† dist/ ç›®å½•æäº¤åˆ° GitHub"
	}
}

def generateMD5(File file) {
	MessageDigest digest = MessageDigest.getInstance("MD5")
	file.withInputStream { is ->
		byte[] buffer = new byte[8192]
		int read
		while ((read = is.read(buffer)) > 0) digest.update(buffer, 0, read)
	}
	return digest.digest().encodeHex().toString()
}
